{"version":3,"sources":["../../src/nextRouteHandler.ts"],"sourcesContent":["import { type FlowgladServer, requestHandler } from '@flowglad/server'\nimport type { HTTPMethod } from '@flowglad/shared'\nimport { type NextRequest, NextResponse } from 'next/server'\n\n/**\n * Options for creating a Next.js App Router route handler with scoped FlowgladServer instances.\n */\nexport interface NextRouteHandlerOptions {\n  /**\n   * Function to extract the customer external ID from the Next.js request.\n   * The customerExternalId should be from YOUR app's database (e.g., user.id or organization.id),\n   * NOT Flowglad's customer ID.\n   *\n   * @param req - The Next.js request object\n   * @returns The customer external ID from your app's database\n   */\n  getCustomerExternalId: (req: NextRequest) => Promise<string>\n  /**\n   * Function that creates a FlowgladServer instance for a specific customer.\n   * @param customerExternalId - The customer's external ID\n   * @returns A FlowgladServer instance scoped to that customer\n   */\n  flowglad: (\n    customerExternalId: string\n  ) => Promise<FlowgladServer> | FlowgladServer\n  /**\n   * Function to run when an error occurs.\n   */\n  onError?: (error: unknown) => void\n  /**\n   * Side effect to run before the request is processed.\n   */\n  beforeRequest?: () => Promise<void>\n  /**\n   * Side effect to run after the request is processed.\n   */\n  afterRequest?: () => Promise<void>\n  /**\n   * Base URL for the Flowglad API.\n   */\n  baseURL?: string\n}\n\ntype NextRouteHandler = (\n  request: NextRequest,\n  {\n    params,\n  }: { params: Promise<{ path: string[] }> | { path: string[] } }\n) => Promise<NextResponse>\n\n/**\n * Creates a Next.js App Router route handler with per-request scoped FlowgladServer instances.\n *\n * This handler dynamically creates a FlowgladServer for each request based on the customer ID\n * extracted from the request. This pattern is useful when you want to scope billing operations\n * to a specific customer (either user or organization level, as defined in your flowglad server constructor)\n * without requiring full authentication setup in the constructor.\n *\n *\n * @param options - Configuration options for the route handler\n * @returns A Next.js App Router handler function\n *\n * @example\n * ```typescript\n * // In your lib/flowglad.ts\n * import { FlowgladServer } from '@flowglad/server'\n *\n * export const flowglad = (customerExternalId: string) => {\n *   return new FlowgladServer({\n *     customerExternalId,\n *     getCustomerDetails: async (externalId) => {\n *       const user = await db.users.findOne({ id: externalId })\n *       return {\n *         email: user.email,\n *         name: user.name,\n *       }\n *     },\n *   })\n * }\n *\n * // In your app/api/flowglad/[...path]/route.ts\n * import { nextRouteHandler } from '@flowglad/nextjs'\n * import { flowglad } from '@/lib/flowglad'\n * import { verifyToken } from '@/lib/auth'\n *\n * export const { GET, POST } = nextRouteHandler({\n *   getCustomerExternalId: async (req) => {\n *     const token = req.headers.get('authorization')?.split(' ')[1]\n *     if (!token) throw new Error('Unauthorized')\n *     const decoded = await verifyToken(token)\n *     return decoded.userId\n *   },\n *   flowglad,\n * })\n *\n * ```\n *\n * For Pages Router, use `pagesRouteHandler` instead.\n */\nexport const nextRouteHandler = (\n  options: NextRouteHandlerOptions\n): {\n  GET: NextRouteHandler\n  POST: NextRouteHandler\n} => {\n  const {\n    getCustomerExternalId,\n    flowglad,\n    onError,\n    beforeRequest,\n    afterRequest,\n    baseURL,\n  } = options\n\n  const routeHandler = async (\n    req: NextRequest,\n    {\n      params,\n    }: { params: Promise<{ path: string[] }> | { path: string[] } }\n  ): Promise<NextResponse> => {\n    try {\n      // Create request handler with customer ID extraction and FlowgladServer factory\n      const handler = requestHandler({\n        getCustomerExternalId,\n        flowglad,\n        onError,\n        beforeRequest,\n        afterRequest,\n        baseURL,\n      })\n\n      // Support both Next 14 and 15\n      // in Next.js 14 params is a plain object, in Next.js 15 params is a Promise (breaking change)\n      const resolvedParams = 'then' in params ? await params : params\n      const { path } = resolvedParams\n      const result = await handler(\n        {\n          path,\n          method: req.method as HTTPMethod,\n          query:\n            req.method === 'GET'\n              ? Object.fromEntries(req.nextUrl.searchParams)\n              : undefined,\n          body:\n            req.method !== 'GET'\n              ? await req.json().catch(() => ({}))\n              : undefined,\n        },\n        req\n      )\n\n      return NextResponse.json(\n        {\n          error: result.error,\n          data: result.data,\n        },\n        {\n          status: result.status,\n        }\n      )\n    } catch (error) {\n      if (onError) {\n        onError(error)\n      }\n      return NextResponse.json(\n        {\n          error: {\n            message:\n              error instanceof Error\n                ? error.message\n                : 'Internal server error',\n          },\n          data: null,\n        },\n        { status: 500 }\n      )\n    }\n  }\n  return {\n    GET: routeHandler,\n    POST: routeHandler,\n  }\n}\n"],"mappings":";;;AAAA,SAA8B,sBAAsB;AAEpD,SAA2B,oBAAoB;AAiGxC,MAAM,mBAAmB,CAC9B,YAIG;AACH,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,IAAI;AAEJ,QAAM,eAAe,CACnB,IACA,OAG0B,eAJ1B,IACA,KAG0B,WAJ1B,KACA;AAAA,IACE;AAAA,EACF,GAC0B;AAC1B,QAAI;AAEF,YAAM,UAAU,eAAe;AAAA,QAC7B;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACF,CAAC;AAID,YAAM,iBAAiB,UAAU,SAAS,MAAM,SAAS;AACzD,YAAM,EAAE,KAAK,IAAI;AACjB,YAAM,SAAS,MAAM;AAAA,QACnB;AAAA,UACE;AAAA,UACA,QAAQ,IAAI;AAAA,UACZ,OACE,IAAI,WAAW,QACX,OAAO,YAAY,IAAI,QAAQ,YAAY,IAC3C;AAAA,UACN,MACE,IAAI,WAAW,QACX,MAAM,IAAI,KAAK,EAAE,MAAM,OAAO,CAAC,EAAE,IACjC;AAAA,QACR;AAAA,QACA;AAAA,MACF;AAEA,aAAO,aAAa;AAAA,QAClB;AAAA,UACE,OAAO,OAAO;AAAA,UACd,MAAM,OAAO;AAAA,QACf;AAAA,QACA;AAAA,UACE,QAAQ,OAAO;AAAA,QACjB;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,UAAI,SAAS;AACX,gBAAQ,KAAK;AAAA,MACf;AACA,aAAO,aAAa;AAAA,QAClB;AAAA,UACE,OAAO;AAAA,YACL,SACE,iBAAiB,QACb,MAAM,UACN;AAAA,UACR;AAAA,UACA,MAAM;AAAA,QACR;AAAA,QACA,EAAE,QAAQ,IAAI;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AACA,SAAO;AAAA,IACL,KAAK;AAAA,IACL,MAAM;AAAA,EACR;AACF;","names":[]}