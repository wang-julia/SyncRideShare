{"version":3,"sources":["../../src/withMCPToolAuthorization.ts"],"sourcesContent":["import type { FlowgladServer } from '@flowglad/server'\nimport { createMcpHandler } from '@vercel/mcp-adapter'\nimport type { NextRequest } from 'next/server'\nimport type { z } from 'zod'\n\nexport type McpHandler = typeof createMcpHandler\n\nexport type InitializeMcpServer = Parameters<McpHandler>[0]\n\nexport type McpServer = Parameters<InitializeMcpServer>[0]\nexport type ToolRegistrar = McpServer['tool']\nexport type ToolCallback = Parameters<ToolRegistrar>[4]\nexport type ToolResponse = ReturnType<ToolCallback>\n\nexport const toolWithFeatureAccessCheck = <T extends z.ZodRawShape>(\n  toolCallback: ToolCallback,\n  params: {\n    featureSlug: string\n    flowgladServer: FlowgladServer\n    upgradePriceSlug: string\n    successUrl: string\n    cancelUrl: string\n  }\n): ToolCallback => {\n  const wrappedCallback = async (\n    ...args: Parameters<ToolCallback>\n  ): Promise<ToolResponse> => {\n    const { featureSlug, flowgladServer, upgradePriceSlug } = params\n    const billing = await flowgladServer.getBilling()\n    const feature = billing.checkFeatureAccess(featureSlug)\n    if (!feature) {\n      const price = billing.getPrice(upgradePriceSlug)\n      if (!price) {\n        return {\n          content: [\n            {\n              type: 'text',\n              text: 'Upgrade price not found',\n            },\n          ],\n        }\n      }\n      const checkoutSession =\n        await params.flowgladServer.createCheckoutSession({\n          priceId: price.id,\n          quantity: 1,\n          successUrl: params.successUrl,\n          cancelUrl: params.cancelUrl,\n        })\n      return {\n        content: [\n          {\n            type: 'text',\n            text: `Feature access denied. To access this feature, please upgrade at: ${checkoutSession.url}`,\n          },\n        ],\n      }\n    }\n    return await toolCallback(...args)\n  }\n  return wrappedCallback as ToolCallback\n}\n\nexport const toolWithUsageBalanceCheck = <T extends z.ZodRawShape>(\n  toolCallback: ToolCallback,\n  featureSlug: string\n): Parameters<ToolRegistrar>[4] => {\n  return async (...args: Parameters<ToolCallback>) => {\n    return await toolCallback(...args)\n  }\n}\n\nexport const mcpHandlerWithFlowglad = (\n  constructor: (\n    server: McpServer,\n    flowglad: FlowgladServer\n  ) => void | Promise<void>,\n  flowgladConstructor: (\n    request: NextRequest\n  ) => Promise<FlowgladServer>\n) => {\n  const handler = async (request: NextRequest) => {\n    const flowglad = await flowgladConstructor(request)\n    const mcpHandler = createMcpHandler(async (server) => {\n      await constructor(server, flowglad)\n      return server\n    })\n    return await mcpHandler(request)\n  }\n\n  return handler\n}\n"],"mappings":";;;AACA,SAAS,wBAAwB;AAa1B,MAAM,6BAA6B,CACxC,cACA,WAOiB;AACjB,QAAM,kBAAkB,IACnB,SACuB;AAC1B,UAAM,EAAE,aAAa,gBAAgB,iBAAiB,IAAI;AAC1D,UAAM,UAAU,MAAM,eAAe,WAAW;AAChD,UAAM,UAAU,QAAQ,mBAAmB,WAAW;AACtD,QAAI,CAAC,SAAS;AACZ,YAAM,QAAQ,QAAQ,SAAS,gBAAgB;AAC/C,UAAI,CAAC,OAAO;AACV,eAAO;AAAA,UACL,SAAS;AAAA,YACP;AAAA,cACE,MAAM;AAAA,cACN,MAAM;AAAA,YACR;AAAA,UACF;AAAA,QACF;AAAA,MACF;AACA,YAAM,kBACJ,MAAM,OAAO,eAAe,sBAAsB;AAAA,QAChD,SAAS,MAAM;AAAA,QACf,UAAU;AAAA,QACV,YAAY,OAAO;AAAA,QACnB,WAAW,OAAO;AAAA,MACpB,CAAC;AACH,aAAO;AAAA,QACL,SAAS;AAAA,UACP;AAAA,YACE,MAAM;AAAA,YACN,MAAM,qEAAqE,gBAAgB,GAAG;AAAA,UAChG;AAAA,QACF;AAAA,MACF;AAAA,IACF;AACA,WAAO,MAAM,aAAa,GAAG,IAAI;AAAA,EACnC;AACA,SAAO;AACT;AAEO,MAAM,4BAA4B,CACvC,cACA,gBACiC;AACjC,SAAO,IAAU,SAAmC;AAClD,WAAO,MAAM,aAAa,GAAG,IAAI;AAAA,EACnC;AACF;AAEO,MAAM,yBAAyB,CACpC,aAIA,wBAGG;AACH,QAAM,UAAU,CAAO,YAAyB;AAC9C,UAAM,WAAW,MAAM,oBAAoB,OAAO;AAClD,UAAM,aAAa,iBAAiB,CAAO,WAAW;AACpD,YAAM,YAAY,QAAQ,QAAQ;AAClC,aAAO;AAAA,IACT,EAAC;AACD,WAAO,MAAM,WAAW,OAAO;AAAA,EACjC;AAEA,SAAO;AACT;","names":[]}