{"version":3,"sources":["../../src/pagesRouteHandler.ts"],"sourcesContent":["import { type FlowgladServer, requestHandler } from '@flowglad/server'\nimport type { HTTPMethod } from '@flowglad/shared'\nimport type { NextApiRequest, NextApiResponse } from 'next'\n\n/**\n * Normalizes Next.js query parameters by:\n * 1. Converting array values to their first element (Next.js can provide array for repeated params)\n * 2. Removing undefined values\n * 3. Ensuring all values are strings\n *\n * @param query - The raw query object from Next.js request\n * @returns A normalized query object with single string values\n */\nconst normalizeQueryParameters = (query: NextApiRequest['query']) => {\n  return Object.fromEntries(\n    Object.entries(query)\n      .map(([key, value]) => [\n        key,\n        Array.isArray(value) ? value[0] : value,\n      ])\n      .filter(\n        (entry): entry is [string, string] => entry[1] !== undefined\n      )\n  )\n}\n\n/**\n * Options for creating a Next.js Pages Router API route handler with scoped FlowgladServer instances.\n */\nexport interface PagesRouteHandlerOptions {\n  /**\n   * Function to extract the customer external ID from the Next.js request.\n   * The customerExternalId should be from YOUR app's database (e.g., user.id or organization.id),\n   * NOT Flowglad's customer ID.\n   *\n   * @param req - The Next.js API request object\n   * @returns The customer external ID from your app's database\n   */\n  getCustomerExternalId: (req: NextApiRequest) => Promise<string>\n  /**\n   * Function that creates a FlowgladServer instance for a specific customer.\n   * @param customerExternalId - The customer's external ID\n   * @returns A FlowgladServer instance scoped to that customer\n   */\n  flowglad: (\n    customerExternalId: string\n  ) => Promise<FlowgladServer> | FlowgladServer\n  /**\n   * Function to run when an error occurs.\n   */\n  onError?: (error: unknown) => void\n  /**\n   * Side effect to run before the request is processed.\n   */\n  beforeRequest?: (\n    req: NextApiRequest,\n    context: {\n      path: string[]\n      method: HTTPMethod\n      query?: Record<string, string>\n      body?: unknown\n    }\n  ) => Promise<void>\n  /**\n   * Side effect to run after the request is processed.\n   */\n  afterRequest?: (\n    req: NextApiRequest,\n    result: {\n      status: number\n      data?: unknown\n      error?: unknown\n    }\n  ) => Promise<void>\n}\n\n/**\n * Creates a Next.js Pages Router API route handler with per-request scoped FlowgladServer instances.\n *\n * This handler dynamically creates a FlowgladServer for each request based on the customer ID\n * extracted from the request. This pattern is useful when you want to scope billing operations\n * to a specific customer (either user or organization level, as defined in your flowglad server constructor)\n * without requiring full authentication setup in the constructor.\n *\n * @param options - Configuration options for the route handler\n * @returns A Next.js Pages Router API handler function\n *\n * @example\n * ```typescript\n * // In your lib/flowglad.ts\n * import { FlowgladServer } from '@flowglad/server'\n *\n * export const flowglad = (customerExternalId: string) => {\n *   return new FlowgladServer({\n *     customerExternalId,\n *     getCustomerDetails: async (externalId) => {\n *       const user = await db.users.findOne({ id: externalId })\n *       return {\n *         email: user.email,\n *         name: user.name,\n *       }\n *     },\n *   })\n * }\n *\n * // In your pages/api/flowglad/[...path].ts\n * import { pagesRouteHandler } from '@flowglad/nextjs/server'\n * import { flowglad } from '@/lib/flowglad'\n * import { verifyToken } from '@/lib/auth'\n *\n * export default pagesRouteHandler({\n *   getCustomerExternalId: async (req) => {\n *     const token = req.headers.authorization?.split(' ')[1]\n *     if (!token) throw new Error('Unauthorized')\n *     const decoded = await verifyToken(token)\n *     return decoded.userId\n *   },\n *   flowglad,\n * })\n * ```\n */\nexport const pagesRouteHandler = (\n  options: PagesRouteHandlerOptions\n): ((req: NextApiRequest, res: NextApiResponse) => Promise<void>) => {\n  const { beforeRequest, afterRequest, ...requestHandlerOptions } =\n    options\n  const handler = requestHandler<NextApiRequest>(\n    requestHandlerOptions\n  )\n\n  return async (req: NextApiRequest, res: NextApiResponse) => {\n    const path = req.query.path as string[]\n    const method = req.method as HTTPMethod\n    const query =\n      req.method === 'GET'\n        ? normalizeQueryParameters(req.query)\n        : undefined\n    const body = req.method !== 'GET' ? req.body : undefined\n\n    let result: {\n      status: number\n      data?: unknown\n      error?: unknown\n    } | null = null\n\n    try {\n      if (beforeRequest) {\n        await beforeRequest(req, { path, method, query, body })\n      }\n\n      result = await handler(\n        {\n          path,\n          method,\n          query,\n          body,\n        },\n        req\n      )\n\n      res.status(result.status).json({\n        error: result.error,\n        data: result.data,\n      })\n    } catch (error) {\n      options.onError?.(error)\n      const errorResult = {\n        status: 500,\n        error: {\n          message:\n            error instanceof Error\n              ? error.message\n              : 'Internal server error',\n        },\n        data: null,\n      }\n      res.status(errorResult.status).json({\n        error: errorResult.error,\n        data: errorResult.data,\n      })\n      result = errorResult\n    } finally {\n      if (afterRequest && result) {\n        await afterRequest(req, result)\n      }\n    }\n  }\n}\n"],"mappings":";;;;AAAA,SAA8B,sBAAsB;AAapD,MAAM,2BAA2B,CAAC,UAAmC;AACnE,SAAO,OAAO;AAAA,IACZ,OAAO,QAAQ,KAAK,EACjB,IAAI,CAAC,CAAC,KAAK,KAAK,MAAM;AAAA,MACrB;AAAA,MACA,MAAM,QAAQ,KAAK,IAAI,MAAM,CAAC,IAAI;AAAA,IACpC,CAAC,EACA;AAAA,MACC,CAAC,UAAqC,MAAM,CAAC,MAAM;AAAA,IACrD;AAAA,EACJ;AACF;AAiGO,MAAM,oBAAoB,CAC/B,YACmE;AACnE,QACE,cADM,iBAAe,aA5HzB,IA6HI,IADsC,kCACtC,IADsC,CAAhC,iBAAe;AAEvB,QAAM,UAAU;AAAA,IACd;AAAA,EACF;AAEA,SAAO,CAAO,KAAqB,QAAyB;AAlI9D,QAAAA;AAmII,UAAM,OAAO,IAAI,MAAM;AACvB,UAAM,SAAS,IAAI;AACnB,UAAM,QACJ,IAAI,WAAW,QACX,yBAAyB,IAAI,KAAK,IAClC;AACN,UAAM,OAAO,IAAI,WAAW,QAAQ,IAAI,OAAO;AAE/C,QAAI,SAIO;AAEX,QAAI;AACF,UAAI,eAAe;AACjB,cAAM,cAAc,KAAK,EAAE,MAAM,QAAQ,OAAO,KAAK,CAAC;AAAA,MACxD;AAEA,eAAS,MAAM;AAAA,QACb;AAAA,UACE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACF;AAAA,QACA;AAAA,MACF;AAEA,UAAI,OAAO,OAAO,MAAM,EAAE,KAAK;AAAA,QAC7B,OAAO,OAAO;AAAA,QACd,MAAM,OAAO;AAAA,MACf,CAAC;AAAA,IACH,SAAS,OAAO;AACd,OAAAA,MAAA,QAAQ,YAAR,gBAAAA,IAAA,cAAkB;AAClB,YAAM,cAAc;AAAA,QAClB,QAAQ;AAAA,QACR,OAAO;AAAA,UACL,SACE,iBAAiB,QACb,MAAM,UACN;AAAA,QACR;AAAA,QACA,MAAM;AAAA,MACR;AACA,UAAI,OAAO,YAAY,MAAM,EAAE,KAAK;AAAA,QAClC,OAAO,YAAY;AAAA,QACnB,MAAM,YAAY;AAAA,MACpB,CAAC;AACD,eAAS;AAAA,IACX,UAAE;AACA,UAAI,gBAAgB,QAAQ;AAC1B,cAAM,aAAa,KAAK,MAAM;AAAA,MAChC;AAAA,IACF;AAAA,EACF;AACF;","names":["_a"]}