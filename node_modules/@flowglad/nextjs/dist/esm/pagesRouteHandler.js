import {
  __async,
  __objRest
} from "./chunk-E2434BE5.js";
import { requestHandler } from "@flowglad/server";
const normalizeQueryParameters = (query) => {
  return Object.fromEntries(
    Object.entries(query).map(([key, value]) => [
      key,
      Array.isArray(value) ? value[0] : value
    ]).filter(
      (entry) => entry[1] !== void 0
    )
  );
};
const pagesRouteHandler = (options) => {
  const _a = options, { beforeRequest, afterRequest } = _a, requestHandlerOptions = __objRest(_a, ["beforeRequest", "afterRequest"]);
  const handler = requestHandler(
    requestHandlerOptions
  );
  return (req, res) => __async(null, null, function* () {
    var _a2;
    const path = req.query.path;
    const method = req.method;
    const query = req.method === "GET" ? normalizeQueryParameters(req.query) : void 0;
    const body = req.method !== "GET" ? req.body : void 0;
    let result = null;
    try {
      if (beforeRequest) {
        yield beforeRequest(req, { path, method, query, body });
      }
      result = yield handler(
        {
          path,
          method,
          query,
          body
        },
        req
      );
      res.status(result.status).json({
        error: result.error,
        data: result.data
      });
    } catch (error) {
      (_a2 = options.onError) == null ? void 0 : _a2.call(options, error);
      const errorResult = {
        status: 500,
        error: {
          message: error instanceof Error ? error.message : "Internal server error"
        },
        data: null
      };
      res.status(errorResult.status).json({
        error: errorResult.error,
        data: errorResult.data
      });
      result = errorResult;
    } finally {
      if (afterRequest && result) {
        yield afterRequest(req, result);
      }
    }
  });
};
export {
  pagesRouteHandler
};
//# sourceMappingURL=pagesRouteHandler.js.map