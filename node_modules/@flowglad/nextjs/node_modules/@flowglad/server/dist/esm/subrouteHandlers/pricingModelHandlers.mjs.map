{"version":3,"sources":["../../../src/subrouteHandlers/pricingModelHandlers.ts"],"sourcesContent":["import type { FlowgladActionKey } from '@flowglad/shared'\nimport type {\n  GetPricingModelResponse,\n  HybridSubRouteHandler,\n} from './types'\n\nexport const getPricingModel: HybridSubRouteHandler<\n  typeof FlowgladActionKey.GetPricingModel\n> = async (params, context) => {\n  const { flowgladServer, flowgladServerAdmin } = context\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // AUTHENTICATED PATH\n  // If flowgladServer exists, auth succeeded - MUST use customer pricing\n  // Any error here is PROPAGATED (500), NOT silently fallen back\n  // ═══════════════════════════════════════════════════════════════════════════\n  if (flowgladServer) {\n    try {\n      const { pricingModel } = await flowgladServer.getPricingModel()\n      const response: GetPricingModelResponse = {\n        pricingModel,\n        source: 'customer',\n      }\n      return {\n        data: { ...response },\n        status: 200,\n      }\n    } catch (error) {\n      // ⚠️ ERROR: Auth succeeded but pricing fetch failed\n      // ⚠️ DO NOT fall back to default - propagate the error\n      console.error(\n        '[GetPricingModel] Customer pricing fetch failed after successful auth:',\n        error\n      )\n      return {\n        data: {},\n        status: 500,\n        error: {\n          code: 'PRICING_MODEL_FETCH_FAILED',\n          json: {\n            message: 'Failed to retrieve customer pricing model',\n            details:\n              error instanceof Error ? error.message : undefined,\n          },\n        },\n      }\n    }\n  }\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // UNAUTHENTICATED PATH\n  // flowgladServer is null, meaning auth was not established\n  // This is the ONLY case where we fall back to default pricing\n  // ═══════════════════════════════════════════════════════════════════════════\n  try {\n    const result = await flowgladServerAdmin.getDefaultPricingModel()\n    // Normalize response shape - handle both { pricingModel } wrapper and direct return\n    const pricingModel =\n      result && typeof result === 'object' && 'pricingModel' in result\n        ? result.pricingModel\n        : result\n    const response: GetPricingModelResponse = {\n      pricingModel,\n      source: 'default',\n    }\n    return {\n      data: { ...response },\n      status: 200,\n    }\n  } catch (error) {\n    // ERROR: Default pricing fetch failed - no fallback available\n    console.error(\n      '[GetPricingModel] Default pricing fetch failed:',\n      error\n    )\n    return {\n      data: {},\n      status: 500,\n      error: {\n        code: 'DEFAULT_PRICING_MODEL_FETCH_FAILED',\n        json: {\n          message: 'Failed to retrieve default pricing model',\n          details: error instanceof Error ? error.message : undefined,\n        },\n      },\n    }\n  }\n}\n"],"mappings":";;;;AAMO,MAAM,kBAET,CAAO,QAAQ,YAAY;AAC7B,QAAM,EAAE,gBAAgB,oBAAoB,IAAI;AAOhD,MAAI,gBAAgB;AAClB,QAAI;AACF,YAAM,EAAE,aAAa,IAAI,MAAM,eAAe,gBAAgB;AAC9D,YAAM,WAAoC;AAAA,QACxC;AAAA,QACA,QAAQ;AAAA,MACV;AACA,aAAO;AAAA,QACL,MAAM,mBAAK;AAAA,QACX,QAAQ;AAAA,MACV;AAAA,IACF,SAAS,OAAO;AAGd,cAAQ;AAAA,QACN;AAAA,QACA;AAAA,MACF;AACA,aAAO;AAAA,QACL,MAAM,CAAC;AAAA,QACP,QAAQ;AAAA,QACR,OAAO;AAAA,UACL,MAAM;AAAA,UACN,MAAM;AAAA,YACJ,SAAS;AAAA,YACT,SACE,iBAAiB,QAAQ,MAAM,UAAU;AAAA,UAC7C;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAOA,MAAI;AACF,UAAM,SAAS,MAAM,oBAAoB,uBAAuB;AAEhE,UAAM,eACJ,UAAU,OAAO,WAAW,YAAY,kBAAkB,SACtD,OAAO,eACP;AACN,UAAM,WAAoC;AAAA,MACxC;AAAA,MACA,QAAQ;AAAA,IACV;AACA,WAAO;AAAA,MACL,MAAM,mBAAK;AAAA,MACX,QAAQ;AAAA,IACV;AAAA,EACF,SAAS,OAAO;AAEd,YAAQ;AAAA,MACN;AAAA,MACA;AAAA,IACF;AACA,WAAO;AAAA,MACL,MAAM,CAAC;AAAA,MACP,QAAQ;AAAA,MACR,OAAO;AAAA,QACL,MAAM;AAAA,QACN,MAAM;AAAA,UACJ,SAAS;AAAA,UACT,SAAS,iBAAiB,QAAQ,MAAM,UAAU;AAAA,QACpD;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;","names":[]}