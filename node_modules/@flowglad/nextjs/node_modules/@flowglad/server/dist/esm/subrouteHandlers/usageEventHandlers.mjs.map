{"version":3,"sources":["../../../src/subrouteHandlers/usageEventHandlers.ts"],"sourcesContent":["import { type FlowgladActionKey, HTTPMethod } from '@flowglad/shared'\nimport { nanoid } from 'nanoid'\nimport type { FlowgladServer } from '../FlowgladServer'\nimport { parseErrorStringToErrorObject } from '../serverUtils'\nimport type {\n  SubRouteHandler,\n  SubRouteHandlerResultData,\n} from './types'\n\nexport const createUsageEvent: SubRouteHandler<\n  FlowgladActionKey.CreateUsageEvent\n> = async (params, flowgladServer: FlowgladServer) => {\n  let error:\n    | { code: string; json: Record<string, unknown> }\n    | undefined\n  let status: number\n  let data: SubRouteHandlerResultData<FlowgladActionKey.CreateUsageEvent> =\n    {}\n  if (params.method !== HTTPMethod.POST) {\n    error = {\n      code: 'Method not allowed',\n      json: {},\n    }\n    status = 405\n    return {\n      data,\n      status,\n      error,\n    }\n  }\n\n  try {\n    // Get billing context for defaults\n    const billing = await flowgladServer.getBilling()\n    const currentSubscription = billing.currentSubscription\n\n    // Apply defaults\n    const subscriptionId =\n      params.data.subscriptionId ?? currentSubscription?.id\n    if (!subscriptionId) {\n      return {\n        data: {},\n        status: 400,\n        error: {\n          code: 'missing_subscription_id',\n          json: {\n            message:\n              'subscriptionId required: no current subscription found',\n          },\n        },\n      }\n    }\n\n    // Validate subscription ownership (align with bulkCreateUsageEvents)\n    const customerSubscriptionIds =\n      billing.currentSubscriptions?.map((sub) => sub.id) ?? []\n    if (!customerSubscriptionIds.includes(subscriptionId)) {\n      return {\n        data: {},\n        status: 403,\n        error: {\n          code: 'forbidden',\n          json: {\n            message: `Subscription ${subscriptionId} is not found among the customer's current subscriptions`,\n          },\n        },\n      }\n    }\n\n    const resolvedParams = {\n      ...params.data,\n      subscriptionId,\n      amount: params.data.amount ?? 1,\n      transactionId: params.data.transactionId ?? nanoid(),\n    }\n\n    const usageEvent =\n      await flowgladServer.createUsageEvent(resolvedParams)\n    data = usageEvent\n    status = 200\n  } catch (e) {\n    if (e instanceof Error) {\n      error = parseErrorStringToErrorObject(e.message)\n    } else {\n      error = {\n        code: 'Unknown error',\n        json: {},\n      }\n    }\n    status = 500\n  }\n  return {\n    data,\n    status,\n    error,\n  }\n}\n"],"mappings":";;;;;AAAA,SAAiC,kBAAkB;AACnD,SAAS,cAAc;AAEvB,SAAS,qCAAqC;AAMvC,MAAM,mBAET,CAAO,QAAQ,mBAAmC;AAXtD;AAYE,MAAI;AAGJ,MAAI;AACJ,MAAI,OACF,CAAC;AACH,MAAI,OAAO,WAAW,WAAW,MAAM;AACrC,YAAQ;AAAA,MACN,MAAM;AAAA,MACN,MAAM,CAAC;AAAA,IACT;AACA,aAAS;AACT,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AAEA,MAAI;AAEF,UAAM,UAAU,MAAM,eAAe,WAAW;AAChD,UAAM,sBAAsB,QAAQ;AAGpC,UAAM,kBACJ,YAAO,KAAK,mBAAZ,YAA8B,2DAAqB;AACrD,QAAI,CAAC,gBAAgB;AACnB,aAAO;AAAA,QACL,MAAM,CAAC;AAAA,QACP,QAAQ;AAAA,QACR,OAAO;AAAA,UACL,MAAM;AAAA,UACN,MAAM;AAAA,YACJ,SACE;AAAA,UACJ;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAGA,UAAM,2BACJ,mBAAQ,yBAAR,mBAA8B,IAAI,CAAC,QAAQ,IAAI,QAA/C,YAAsD,CAAC;AACzD,QAAI,CAAC,wBAAwB,SAAS,cAAc,GAAG;AACrD,aAAO;AAAA,QACL,MAAM,CAAC;AAAA,QACP,QAAQ;AAAA,QACR,OAAO;AAAA,UACL,MAAM;AAAA,UACN,MAAM;AAAA,YACJ,SAAS,gBAAgB,cAAc;AAAA,UACzC;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAEA,UAAM,iBAAiB,iCAClB,OAAO,OADW;AAAA,MAErB;AAAA,MACA,SAAQ,YAAO,KAAK,WAAZ,YAAsB;AAAA,MAC9B,gBAAe,YAAO,KAAK,kBAAZ,YAA6B,OAAO;AAAA,IACrD;AAEA,UAAM,aACJ,MAAM,eAAe,iBAAiB,cAAc;AACtD,WAAO;AACP,aAAS;AAAA,EACX,SAAS,GAAG;AACV,QAAI,aAAa,OAAO;AACtB,cAAQ,8BAA8B,EAAE,OAAO;AAAA,IACjD,OAAO;AACL,cAAQ;AAAA,QACN,MAAM;AAAA,QACN,MAAM,CAAC;AAAA,MACT;AAAA,IACF;AACA,aAAS;AAAA,EACX;AACA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;","names":[]}