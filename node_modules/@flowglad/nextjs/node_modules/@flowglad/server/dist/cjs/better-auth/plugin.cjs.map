{"version":3,"sources":["../../../src/better-auth/plugin.ts"],"sourcesContent":["import { createAuthMiddleware } from 'better-auth/plugins'\nimport { FlowgladServer } from '../FlowgladServer'\nimport {\n  createBillingEndpoints,\n  createGetExternalIdEndpoint,\n  createGetPricingModelEndpoint,\n  getCreatorRoleFromOrgOptions,\n  getOrganizationDetails,\n  getOrgOptionsFromCtxContext,\n  isAdapterLike,\n} from './endpoints'\nimport type {\n  FlowgladBetterAuthPluginOptions,\n  InnerSession,\n} from './types'\n\ntype BetterAuthPluginType = import('better-auth').BetterAuthPlugin\ntype FlowgladPlugin = BetterAuthPluginType & {\n  id: 'flowglad'\n  endpoints: NonNullable<BetterAuthPluginType['endpoints']>\n  hooks: NonNullable<BetterAuthPluginType['hooks']> & {\n    after: NonNullable<\n      NonNullable<BetterAuthPluginType['hooks']>['after']\n    >\n  }\n}\n\n/**\n * Helper function to get default customer info from Better Auth session\n */\nconst getDefaultCustomer = async (\n  session: InnerSession,\n  customerType: 'user' | 'organization'\n): Promise<{\n  externalId: string\n  name: string\n  email: string\n}> => {\n  if (customerType === 'organization') {\n    const orgId = session.user.organizationId\n    if (!orgId) {\n      throw new Error('Organization ID not found in session')\n    }\n    // For organizations, use organization ID as externalId\n    // Use user's name/email as fallback (users can provide custom getCustomer for org-specific logic)\n    return {\n      externalId: orgId,\n      name: session.user.name || 'Organization',\n      email: session.user.email || '',\n    }\n  }\n\n  // Default: use user info from session\n  if (!session.user.email) {\n    throw new Error(\n      'User email is required to create Flowglad customer'\n    )\n  }\n  return {\n    externalId: session.user.id,\n    name: session.user.name || '',\n    email: session.user.email,\n  }\n}\n\n/**\n * Creates a Flowglad customer after Better Auth user/org creation\n */\nconst createFlowgladCustomer = async (\n  options: FlowgladBetterAuthPluginOptions,\n  session: InnerSession\n): Promise<void> => {\n  const customerType = options.customerType || 'user'\n\n  // Get customer info - use custom function if provided, otherwise use defaults\n  const customerInfo = options.getCustomer\n    ? await options.getCustomer(session)\n    : await getDefaultCustomer(session, customerType)\n\n  // Create Flowglad customer\n  const apiKey = options.apiKey || process.env.FLOWGLAD_SECRET_KEY\n  const flowgladServerConfig: {\n    customerExternalId: string\n    getCustomerDetails: () => Promise<{ name: string; email: string }>\n    apiKey?: string\n    baseURL?: string\n  } = {\n    customerExternalId: customerInfo.externalId,\n    getCustomerDetails: async () => ({\n      name: customerInfo.name,\n      email: customerInfo.email,\n    }),\n  }\n  if (apiKey) {\n    flowgladServerConfig.apiKey = apiKey\n  }\n  if (options.baseURL) {\n    flowgladServerConfig.baseURL = options.baseURL\n  }\n  const flowgladServer = new FlowgladServer(flowgladServerConfig)\n\n  // This will find or create the customer\n  await flowgladServer.findOrCreateCustomer()\n}\n\nconst reportCustomerCreateError = async (\n  options: FlowgladBetterAuthPluginOptions,\n  params: {\n    hook: 'afterSignUp' | 'afterOrganizationCreate'\n    customerType: 'user' | 'organization'\n    session: InnerSession\n    error: unknown\n  }\n): Promise<void> => {\n  if (options.onCustomerCreateError) {\n    await options.onCustomerCreateError(params)\n    return\n  }\n\n  if (params.hook === 'afterSignUp') {\n    console.error(\n      'Failed to create Flowglad customer after sign-up:',\n      params.error\n    )\n    return\n  }\n\n  console.error(\n    'Failed to create Flowglad customer after organization creation:',\n    params.error\n  )\n}\n\n/**\n * Helper function to create Flowglad customer for an organization\n * Can be called directly when organization is created programmatically\n */\nexport const createFlowgladCustomerForOrganization = async (\n  options: FlowgladBetterAuthPluginOptions,\n  params: {\n    organizationId: string\n    userId: string\n    userEmail: string\n    userName?: string | null\n    organizationName?: string\n    organizationEmail?: string\n  }\n): Promise<void> => {\n  const {\n    organizationId,\n    userId,\n    userEmail,\n    userName,\n    organizationName,\n    organizationEmail,\n  } = params\n  const session: InnerSession = {\n    user: {\n      id: userId,\n      email: organizationEmail ?? userEmail,\n      name: organizationName ?? userName ?? null,\n      organizationId,\n    },\n  }\n\n  await createFlowgladCustomer(options, session)\n}\n\nexport const flowgladPlugin = (\n  options: FlowgladBetterAuthPluginOptions\n) => {\n  const plugin = {\n    id: 'flowglad',\n    endpoints: {\n      getExternalId: createGetExternalIdEndpoint(options),\n      ...createBillingEndpoints(options),\n      getPricingModel: createGetPricingModelEndpoint(options),\n    },\n    hooks: {\n      after: [\n        {\n          matcher: (context) => {\n            // Match user creation endpoints\n            return (\n              context.path === '/sign-up' ||\n              context.path === '/sign-up/email'\n            )\n          },\n          handler: createAuthMiddleware(async (ctx) => {\n            // In after hooks, the user should be available in the context\n            // Try to get user from context - Better Auth should have it after sign-up\n            const returned = ctx.context.returned as\n              | {\n                  user?: {\n                    id?: string\n                    email?: string\n                    name?: string\n                  }\n                }\n              | undefined\n\n            if (!returned?.user?.id) {\n              // No user created, skip\n              return\n            }\n\n            // Create a session-like object from the returned user data\n            const session: InnerSession = {\n              user: {\n                id: returned.user.id,\n                name: returned.user.name || null,\n                email: returned.user.email || null,\n                organizationId: null,\n              },\n            }\n\n            // Only create Flowglad customer if customerType is 'user' or not specified\n            const customerType = options.customerType || 'user'\n            if (customerType !== 'user') {\n              return\n            }\n\n            try {\n              await createFlowgladCustomer(options, session)\n            } catch (error) {\n              // Best-effort: do not fail the sign-up process\n              await reportCustomerCreateError(options, {\n                hook: 'afterSignUp',\n                customerType,\n                session,\n                error,\n              })\n            }\n          }),\n        },\n        {\n          matcher: (context) => {\n            // Match organization creation endpoint (if using org plugin)\n            return context.path === '/organization/create'\n          },\n          handler: createAuthMiddleware(async (ctx) => {\n            // In after hooks, the organization should be available in the context\n            // Try to get organization from context - Better Auth should have it after org creation\n            const returned = ctx.context.returned as\n              | {\n                  organization?: {\n                    id?: string\n                    name?: string\n                    slug?: string\n                  }\n                  member?: {\n                    userId?: string\n                    organizationId?: string\n                  }\n                }\n              | undefined\n\n            if (!returned?.organization?.id) {\n              return\n            }\n\n            // Get session from context to get user info\n            const session = ctx.context.session\n            if (!session?.user) {\n              return\n            }\n\n            // Only create Flowglad customer if customerType is 'organization'\n            const customerType = options.customerType || 'user'\n            if (customerType !== 'organization') {\n              return\n            }\n\n            const organizationId = returned.organization.id\n            const organizationName =\n              typeof returned.organization.name === 'string'\n                ? returned.organization.name\n                : 'Organization'\n\n            const organizationEmail =\n              isAdapterLike(ctx.context.adapter) &&\n              typeof session.user.id === 'string'\n                ? ((\n                    await getOrganizationDetails({\n                      adapter: ctx.context.adapter,\n                      organizationId,\n                      userId: session.user.id,\n                      creatorRole: getCreatorRoleFromOrgOptions(\n                        getOrgOptionsFromCtxContext(ctx.context)\n                      ),\n                    })\n                  )?.email ??\n                  session.user.email ??\n                  null)\n                : (session.user.email ?? null)\n\n            // Create a session-like object with organization ID\n            const orgSession: InnerSession = {\n              user: {\n                id: session.user.id,\n                // For org customers, we want Flowglad customer name/email to\n                // default to org name + owner email (best-effort).\n                name: organizationName,\n                email: organizationEmail,\n                organizationId,\n              },\n            }\n\n            try {\n              await createFlowgladCustomer(options, orgSession)\n            } catch (error) {\n              // Best-effort: do not fail the organization creation process\n              await reportCustomerCreateError(options, {\n                hook: 'afterOrganizationCreate',\n                customerType,\n                session: orgSession,\n                error,\n              })\n            }\n          }),\n        },\n      ],\n    },\n  } satisfies FlowgladPlugin\n\n  return plugin\n}\n"],"mappings":"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","names":[]}