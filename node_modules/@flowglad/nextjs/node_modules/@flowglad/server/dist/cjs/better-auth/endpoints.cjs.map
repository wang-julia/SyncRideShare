{"version":3,"sources":["../../../src/better-auth/endpoints.ts"],"sourcesContent":["import {\n  type AuthenticatedActionKey,\n  FlowgladActionKey,\n  flowgladActionValidators,\n  HTTPMethod,\n} from '@flowglad/shared'\nimport { getSessionFromCtx } from 'better-auth/api'\nimport { createAuthEndpoint } from 'better-auth/plugins'\nimport { z } from 'zod'\nimport { FlowgladServer } from '../FlowgladServer'\nimport { FlowgladServerAdmin } from '../FlowgladServerAdmin'\nimport { routeToHandlerMap } from '../subrouteHandlers'\nimport { getPricingModel } from '../subrouteHandlers/pricingModelHandlers'\nimport type {\n  BetterAuthSessionResult,\n  FlowgladBetterAuthPluginOptions,\n  FlowgladEndpointError,\n  InnerSession,\n} from './types'\n\nexport type AdapterWhereClause = { field: string; value: string }\n\nexport type AdapterFindArgs = {\n  model: string\n  where: AdapterWhereClause[]\n}\n\nexport type AdapterLike = {\n  findOne: (args: AdapterFindArgs) => Promise<unknown>\n  findMany: (args: AdapterFindArgs) => Promise<unknown>\n}\n\nexport const isRecord = (\n  value: unknown\n): value is Record<string, unknown> => {\n  return (\n    typeof value === 'object' &&\n    value !== null &&\n    !Array.isArray(value)\n  )\n}\n\nexport const getStringProp = (\n  record: Record<string, unknown>,\n  key: string\n): string | null => {\n  const value = record[key]\n  if (typeof value !== 'string') {\n    return null\n  }\n  return value\n}\n\nexport const isAdapterLike = (\n  value: unknown\n): value is AdapterLike => {\n  if (!isRecord(value)) {\n    return false\n  }\n  return (\n    typeof value.findOne === 'function' &&\n    typeof value.findMany === 'function'\n  )\n}\n\n/**\n * Better Auth's `ctx.context` shape differs across versions/plugins.\n * We access `orgOptions` in a duck-typed, best-effort way to avoid\n * coupling Flowglad's plugin types to Better Auth internals.\n */\nexport const getOrgOptionsFromCtxContext = (\n  ctxContext: unknown\n): Record<string, unknown> | undefined => {\n  if (!isRecord(ctxContext)) {\n    return undefined\n  }\n  const orgOptions = ctxContext.orgOptions\n  if (!isRecord(orgOptions)) {\n    return undefined\n  }\n  return orgOptions\n}\n\nexport const getCreatorRoleFromOrgOptions = (\n  orgOptions: Record<string, unknown> | undefined\n): string | undefined => {\n  if (!orgOptions) {\n    return undefined\n  }\n  const creatorRole = orgOptions.creatorRole\n  return typeof creatorRole === 'string' ? creatorRole : undefined\n}\n\n/**\n * Best-effort organization lookup via Better Auth adapter.\n *\n * Returns null if the current user is not a member of the organization.\n * If the org exists but owner email can't be determined, email may be \"\".\n *\n * Parallelizes the first three queries (member check, org lookup, owner members)\n * to reduce database round trips from 3 to 2 in the worst case. This trades\n * potentially executing unnecessary queries (if user isn't a member) for\n * reduced latency in the common case.\n *\n * Exported for testing.\n */\nexport const getOrganizationDetails = async (params: {\n  adapter: AdapterLike\n  organizationId: string\n  userId: string\n  creatorRole?: string\n}): Promise<{ id: string; name: string; email: string } | null> => {\n  const creatorRole = params.creatorRole ?? 'owner'\n\n  // Parallel: member check, org lookup, owner members (round trip 1)\n  const [memberResult, organizationResult, ownerMembersResult] =\n    await Promise.all([\n      params.adapter.findOne({\n        model: 'member',\n        where: [\n          { field: 'userId', value: params.userId },\n          { field: 'organizationId', value: params.organizationId },\n        ],\n      }),\n      params.adapter.findOne({\n        model: 'organization',\n        where: [{ field: 'id', value: params.organizationId }],\n      }),\n      params.adapter.findMany({\n        model: 'member',\n        where: [\n          { field: 'organizationId', value: params.organizationId },\n          { field: 'role', value: creatorRole },\n        ],\n      }),\n    ])\n\n  // Early exit if not a member (queries 2&3 were \"wasted\" but no extra round trip)\n  if (!isRecord(memberResult)) {\n    return null\n  }\n\n  // Determine owner user ID\n  const memberRole = getStringProp(memberResult, 'role')\n  const memberUserId =\n    getStringProp(memberResult, 'userId') ?? params.userId\n  let ownerUserId: string | null =\n    memberRole === creatorRole ? memberUserId : null\n\n  if (!ownerUserId && Array.isArray(ownerMembersResult)) {\n    const firstOwner = ownerMembersResult.find(isRecord) ?? null\n    ownerUserId = firstOwner\n      ? getStringProp(firstOwner, 'userId')\n      : null\n  }\n\n  // Single additional query for owner user if needed (round trip 2)\n  const ownerUserResult = ownerUserId\n    ? await params.adapter.findOne({\n        model: 'user',\n        where: [{ field: 'id', value: ownerUserId }],\n      })\n    : null\n\n  const organizationName = isRecord(organizationResult)\n    ? (getStringProp(organizationResult, 'name') ??\n      getStringProp(organizationResult, 'slug') ??\n      'Organization')\n    : 'Organization'\n\n  const ownerEmail = isRecord(ownerUserResult)\n    ? (getStringProp(ownerUserResult, 'email') ?? '')\n    : ''\n\n  return {\n    id: params.organizationId,\n    name: organizationName,\n    email: ownerEmail,\n  }\n}\n\nexport const createGetCustomerDetails = (params: {\n  options: FlowgladBetterAuthPluginOptions\n  session: BetterAuthSessionResult\n  ctxContext: unknown\n  adapter: unknown\n}): (() => Promise<{ name: string; email: string }>) => {\n  return async () => {\n    const organizationId =\n      params.options.customerType === 'organization'\n        ? (params.session.session.activeOrganizationId ?? null)\n        : null\n\n    const innerSession: InnerSession = {\n      user: {\n        id: params.session.user.id,\n        name: params.session.user.name || '',\n        email: params.session.user.email || '',\n        organizationId,\n      },\n    }\n\n    if (params.options.getCustomer) {\n      const customerInfo =\n        await params.options.getCustomer(innerSession)\n      return { name: customerInfo.name, email: customerInfo.email }\n    }\n\n    if (\n      params.options.customerType === 'organization' &&\n      params.session.session.activeOrganizationId &&\n      isAdapterLike(params.adapter)\n    ) {\n      const creatorRole = getCreatorRoleFromOrgOptions(\n        getOrgOptionsFromCtxContext(params.ctxContext)\n      )\n\n      const org = await getOrganizationDetails({\n        adapter: params.adapter,\n        organizationId: params.session.session.activeOrganizationId,\n        userId: params.session.user.id,\n        creatorRole,\n      })\n\n      if (org) {\n        return { name: org.name, email: org.email }\n      }\n    }\n\n    return {\n      name: params.session.user.name || '',\n      email: params.session.user.email || '',\n    }\n  }\n}\n\n/**\n * Resolves the customer external ID from a Better Auth session.\n * Returns an error if organization billing is configured but no active organization exists.\n */\nexport const resolveCustomerExternalId = (\n  options: FlowgladBetterAuthPluginOptions,\n  session: BetterAuthSessionResult\n): { externalId: string } | { error: FlowgladEndpointError } => {\n  if (options.customerType === 'organization') {\n    if (!session.session.activeOrganizationId) {\n      return {\n        error: {\n          code: 'NO_ACTIVE_ORGANIZATION',\n          message:\n            'Organization billing requires an active organization. Please select or create an organization first.',\n        },\n      }\n    }\n    return { externalId: session.session.activeOrganizationId }\n  }\n  return { externalId: session.session.userId }\n}\n\nexport const createGetExternalIdEndpoint = (\n  options: FlowgladBetterAuthPluginOptions\n) => {\n  return createAuthEndpoint(\n    '/flowglad/get-external-id',\n    {\n      method: 'GET',\n      metadata: {\n        isAction: true,\n      },\n    },\n    async (ctx) => {\n      if (!ctx.headers || !ctx.headers.get) {\n        throw new Error(\n          'Flowglad Better Auth Plugin: Headers are required for getExternalId().\\n' +\n            'Usage: await auth.api.getExternalId({ headers: await headers() })'\n        )\n      }\n      const session = await getSessionFromCtx(ctx)\n      if (!session) {\n        return ctx.json({\n          externalId: null,\n        })\n      }\n      const organizationId: string | undefined =\n        session.session.activeOrganizationId\n\n      if (options.customerType === 'organization') {\n        return ctx.json({\n          externalId: organizationId ?? null,\n        })\n      }\n\n      return ctx.json({\n        externalId: session.session.userId,\n      })\n    }\n  )\n}\n\nconst createFlowgladBillingEndpoint = <\n  T extends AuthenticatedActionKey,\n  S extends z.ZodTypeAny,\n>(params: {\n  actionKey: T\n  validator: {\n    method: (typeof flowgladActionValidators)[T]['method']\n    inputValidator: S\n  }\n  handler: (\n    params: {\n      method: (typeof flowgladActionValidators)[T]['method']\n      data: z.output<S>\n    },\n    flowgladServer: FlowgladServer\n  ) => Promise<{\n    data: {}\n    status: number\n    error?: {\n      code: string\n      json: Record<string, unknown>\n    }\n  }>\n  options: FlowgladBetterAuthPluginOptions\n}) => {\n  return createAuthEndpoint(\n    `/flowglad/${params.actionKey}`,\n    {\n      method: 'POST',\n      // Use a permissive schema so Better Call parses the JSON body for us\n      // Handlers will do their own validation\n      body: z.record(z.string(), z.any()),\n      metadata: {\n        isAction: true,\n      },\n    },\n    async (ctx) => {\n      // 1. Authenticate\n      const sessionResult = await getSessionFromCtx(ctx)\n      if (!sessionResult) {\n        return ctx.json(\n          {\n            error: {\n              code: 'UNAUTHORIZED',\n              message: 'Authentication required',\n            },\n          },\n          { status: 401 }\n        )\n      }\n\n      // Cast to our expected session type\n      const session =\n        sessionResult as unknown as BetterAuthSessionResult\n\n      const getCustomerDetailsForSession = createGetCustomerDetails({\n        options: params.options,\n        session,\n        ctxContext: ctx.context,\n        adapter: ctx.context.adapter,\n      })\n\n      // 2. Resolve customer ID with explicit error for missing org\n      const customerResult = resolveCustomerExternalId(\n        params.options,\n        session\n      )\n      if ('error' in customerResult) {\n        return ctx.json(\n          { error: customerResult.error },\n          { status: 400 }\n        )\n      }\n\n      // 2b. Defense-in-depth: verify user membership for organization billing\n      // Better Auth should enforce this when setting activeOrganizationId,\n      // but explicit verification guards against session manipulation or bugs\n      if (\n        params.options.customerType === 'organization' &&\n        isAdapterLike(ctx.context.adapter)\n      ) {\n        const membership = await ctx.context.adapter.findOne({\n          model: 'member',\n          where: [\n            { field: 'userId', value: session.user.id },\n            {\n              field: 'organizationId',\n              value: customerResult.externalId,\n            },\n          ],\n        })\n        if (!isRecord(membership)) {\n          return ctx.json(\n            {\n              error: {\n                code: 'NOT_ORGANIZATION_MEMBER',\n                message: 'You are not a member of this organization',\n              },\n            },\n            { status: 403 }\n          )\n        }\n      }\n\n      // 3. Get request body (already parsed by Better Call due to body schema)\n      // Handlers will do their own validation (consistent with standalone requestHandler)\n      const rawBody: Record<string, unknown> = isRecord(ctx.body)\n        ? ctx.body\n        : {}\n\n      /**\n       * IMPORTANT: In Flowglad's action schemas, `externalId` is overloaded:\n       * - For customer endpoints it refers to the *customer externalId* (derived from session)\n       * - For resource-claim endpoints it refers to the *claim externalId* (user-provided)\n       *\n       * So we must ONLY inject the customer externalId for the small set of endpoints\n       * that are explicitly defined to take it, otherwise we overwrite legitimate inputs\n       * (e.g. `claimResource({ externalId: inviteeEmail })`).\n       */\n      const shouldInjectCustomerExternalIdIntoBody =\n        params.actionKey === FlowgladActionKey.GetCustomerBilling ||\n        params.actionKey === FlowgladActionKey.FindOrCreateCustomer ||\n        params.actionKey === FlowgladActionKey.UpdateCustomer\n\n      const bodyForValidation: Record<string, unknown> =\n        shouldInjectCustomerExternalIdIntoBody\n          ? {\n              ...rawBody,\n              externalId: customerResult.externalId,\n            }\n          : rawBody\n\n      const validatedBody =\n        params.validator.inputValidator.safeParse(bodyForValidation)\n      if (!validatedBody.success) {\n        return ctx.json(\n          {\n            error: {\n              code: 'VALIDATION_ERROR',\n              message: 'Invalid request body',\n              details: validatedBody.error.flatten(),\n            },\n          },\n          { status: 400 }\n        )\n      }\n\n      // 4. Create FlowgladServer and delegate to handler\n      const apiKey =\n        params.options.apiKey || process.env.FLOWGLAD_SECRET_KEY\n      const flowgladServerConfig: {\n        customerExternalId: string\n        getCustomerDetails: () => Promise<{\n          name: string\n          email: string\n        }>\n        apiKey?: string\n        baseURL?: string\n      } = {\n        customerExternalId: customerResult.externalId,\n        getCustomerDetails: getCustomerDetailsForSession,\n      }\n      if (apiKey) {\n        flowgladServerConfig.apiKey = apiKey\n      }\n      if (params.options.baseURL) {\n        flowgladServerConfig.baseURL = params.options.baseURL\n      }\n\n      const flowgladServer = new FlowgladServer(flowgladServerConfig)\n\n      // 5. Call the handler\n      const result = await params.handler(\n        {\n          method: params.validator.method,\n          data: validatedBody.data,\n        },\n        flowgladServer\n      )\n\n      if (result.error) {\n        return ctx.json(\n          {\n            error: {\n              code: result.error.code,\n              message:\n                typeof result.error.json?.message === 'string'\n                  ? result.error.json.message\n                  : `Flowglad API error: ${result.error.code}`,\n              details: result.error.json,\n            },\n          },\n          { status: result.status }\n        )\n      }\n\n      return ctx.json(\n        { data: result.data },\n        { status: result.status }\n      )\n    }\n  )\n}\n\nexport const createGetPricingModelEndpoint = (\n  options: FlowgladBetterAuthPluginOptions\n) => {\n  return createAuthEndpoint(\n    '/flowglad/pricing-models/retrieve',\n    {\n      method: 'POST',\n      metadata: {\n        isAction: true,\n      },\n    },\n    async (ctx) => {\n      const apiKey = options.apiKey || process.env.FLOWGLAD_SECRET_KEY\n      if (!apiKey) {\n        return ctx.json(\n          {\n            error: {\n              code: 'CONFIGURATION_ERROR',\n              message:\n                'API key required. Provide apiKey option or set FLOWGLAD_SECRET_KEY.',\n            },\n          },\n          { status: 500 }\n        )\n      }\n\n      // Create FlowgladServerAdmin (always needed for fallback)\n      const flowgladServerAdmin = new FlowgladServerAdmin({\n        apiKey,\n        baseURL: options.baseURL,\n      })\n\n      // Attempt authentication to determine if we have an authenticated user\n      let flowgladServer: FlowgladServer | null = null\n\n      const sessionResult = await getSessionFromCtx(ctx)\n      if (sessionResult) {\n        const session =\n          sessionResult as unknown as BetterAuthSessionResult\n        const customerResult = resolveCustomerExternalId(\n          options,\n          session\n        )\n\n        // Only create FlowgladServer if customer resolution succeeded\n        if (!('error' in customerResult)) {\n          const getCustomerDetailsForSession =\n            createGetCustomerDetails({\n              options,\n              session,\n              ctxContext: ctx.context,\n              adapter: ctx.context.adapter,\n            })\n\n          const flowgladServerConfig: {\n            customerExternalId: string\n            getCustomerDetails: () => Promise<{\n              name: string\n              email: string\n            }>\n            apiKey?: string\n            baseURL?: string\n          } = {\n            customerExternalId: customerResult.externalId,\n            getCustomerDetails: getCustomerDetailsForSession,\n          }\n          if (apiKey) {\n            flowgladServerConfig.apiKey = apiKey\n          }\n          if (options.baseURL) {\n            flowgladServerConfig.baseURL = options.baseURL\n          }\n          flowgladServer = new FlowgladServer(flowgladServerConfig)\n        }\n      }\n\n      // Delegate to the shared handler\n      const result = await getPricingModel(\n        { method: HTTPMethod.POST, data: {} },\n        { flowgladServer, flowgladServerAdmin }\n      )\n\n      // Map handler response to better-auth response format\n      if (result.error) {\n        const errorJson = result.error.json\n        const message =\n          typeof errorJson?.message === 'string'\n            ? errorJson.message\n            : undefined\n        const details =\n          typeof errorJson?.details === 'string'\n            ? errorJson.details\n            : undefined\n        return ctx.json(\n          {\n            error: {\n              code: result.error.code,\n              message,\n              details,\n            },\n          },\n          { status: result.status }\n        )\n      }\n\n      return ctx.json({ data: result.data })\n    }\n  )\n}\n\nexport const createBillingEndpoints = (\n  options: FlowgladBetterAuthPluginOptions\n) => {\n  return {\n    getCustomerBilling: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.GetCustomerBilling,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.GetCustomerBilling\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.GetCustomerBilling],\n      options,\n    }),\n    findOrCreateCustomer: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.FindOrCreateCustomer,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.FindOrCreateCustomer\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.FindOrCreateCustomer],\n      options,\n    }),\n    createCheckoutSession: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.CreateCheckoutSession,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.CreateCheckoutSession\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.CreateCheckoutSession],\n      options,\n    }),\n    createAddPaymentMethodCheckoutSession:\n      createFlowgladBillingEndpoint({\n        actionKey:\n          FlowgladActionKey.CreateAddPaymentMethodCheckoutSession,\n        validator:\n          flowgladActionValidators[\n            FlowgladActionKey.CreateAddPaymentMethodCheckoutSession\n          ],\n        handler:\n          routeToHandlerMap[\n            FlowgladActionKey.CreateAddPaymentMethodCheckoutSession\n          ],\n        options,\n      }),\n    createActivateSubscriptionCheckoutSession:\n      createFlowgladBillingEndpoint({\n        actionKey:\n          FlowgladActionKey.CreateActivateSubscriptionCheckoutSession,\n        validator:\n          flowgladActionValidators[\n            FlowgladActionKey\n              .CreateActivateSubscriptionCheckoutSession\n          ],\n        handler:\n          routeToHandlerMap[\n            FlowgladActionKey\n              .CreateActivateSubscriptionCheckoutSession\n          ],\n        options,\n      }),\n    cancelSubscription: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.CancelSubscription,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.CancelSubscription\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.CancelSubscription],\n      options,\n    }),\n    uncancelSubscription: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.UncancelSubscription,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.UncancelSubscription\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.UncancelSubscription],\n      options,\n    }),\n    adjustSubscription: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.AdjustSubscription,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.AdjustSubscription\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.AdjustSubscription],\n      options,\n    }),\n    createSubscription: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.CreateSubscription,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.CreateSubscription\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.CreateSubscription],\n      options,\n    }),\n    updateCustomer: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.UpdateCustomer,\n      validator:\n        flowgladActionValidators[FlowgladActionKey.UpdateCustomer],\n      handler: routeToHandlerMap[FlowgladActionKey.UpdateCustomer],\n      options,\n    }),\n    createUsageEvent: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.CreateUsageEvent,\n      validator:\n        flowgladActionValidators[FlowgladActionKey.CreateUsageEvent],\n      handler: routeToHandlerMap[FlowgladActionKey.CreateUsageEvent],\n      options,\n    }),\n    // Resource claim endpoints\n    getResources: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.GetResourceUsages,\n      validator:\n        flowgladActionValidators[FlowgladActionKey.GetResourceUsages],\n      handler: routeToHandlerMap[FlowgladActionKey.GetResourceUsages],\n      options,\n    }),\n    getResourceUsage: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.GetResourceUsage,\n      validator:\n        flowgladActionValidators[FlowgladActionKey.GetResourceUsage],\n      handler: routeToHandlerMap[FlowgladActionKey.GetResourceUsage],\n      options,\n    }),\n    claimResource: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.ClaimResource,\n      validator:\n        flowgladActionValidators[FlowgladActionKey.ClaimResource],\n      handler: routeToHandlerMap[FlowgladActionKey.ClaimResource],\n      options,\n    }),\n    releaseResource: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.ReleaseResource,\n      validator:\n        flowgladActionValidators[FlowgladActionKey.ReleaseResource],\n      handler: routeToHandlerMap[FlowgladActionKey.ReleaseResource],\n      options,\n    }),\n    listResourceClaims: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.ListResourceClaims,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.ListResourceClaims\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.ListResourceClaims],\n      options,\n    }),\n    // Usage meter endpoints\n    getUsageMeterBalances: createFlowgladBillingEndpoint({\n      actionKey: FlowgladActionKey.GetUsageMeterBalances,\n      validator:\n        flowgladActionValidators[\n          FlowgladActionKey.GetUsageMeterBalances\n        ],\n      handler:\n        routeToHandlerMap[FlowgladActionKey.GetUsageMeterBalances],\n      options,\n    }),\n  }\n}\n"],"mappings":"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","names":[]}