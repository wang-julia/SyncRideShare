{"version":3,"sources":["../../src/useUsageMeters.tsx"],"sourcesContent":["'use client'\nimport {\n  type CustomerBillingDetails,\n  FlowgladActionKey,\n  flowgladActionValidators,\n  type GetUsageMeterBalancesParams,\n  type GetUsageMeterBalancesResponse,\n  type UsageMeterBalance,\n} from '@flowglad/shared'\nimport { useQuery } from '@tanstack/react-query'\nimport { useFlowgladConfig } from './FlowgladConfigContext'\nimport { getFlowgladRoute } from './FlowgladContext'\n\n/** Query key for usage meters caching */\nexport const USAGE_METERS_QUERY_KEY = 'flowglad-usage-meters'\n\ntype UsageMeterBalancesRouteResponse =\n  | {\n      data?: GetUsageMeterBalancesResponse | null\n      error?: { code: string; json: Record<string, unknown> } | null\n    }\n  | undefined\n\n/**\n * Result type for the useUsageMeters hook.\n */\nexport interface UseUsageMetersResult {\n  /** All usage meter balances. Undefined until loaded. */\n  usageMeters: UsageMeterBalance[] | undefined\n  /** Loading state for initial fetch */\n  isLoading: boolean\n  /** Error if fetch failed */\n  error: Error | null\n}\n\n/**\n * Result type for the useUsageMeter hook.\n */\nexport interface UseUsageMeterResult {\n  /** Usage meter balance for the specific slug, or null if not found. */\n  usageMeter: UsageMeterBalance | null\n  /** Loading state for initial fetch */\n  isLoading: boolean\n  /** Error if fetch failed */\n  error: Error | null\n}\n\n/**\n * Derives usage meter balances from billingMocks data.\n * Extracts usageMeterBalances from currentSubscriptions[].experimental.\n */\nconst deriveUsageMeterBalancesFromBillingMocks = (\n  billingMocks: CustomerBillingDetails\n): UsageMeterBalance[] => {\n  const currentSubscriptions = billingMocks.currentSubscriptions ?? []\n  const balances: UsageMeterBalance[] = []\n\n  for (const subscription of currentSubscriptions) {\n    const experimental = subscription.experimental\n    if (experimental?.usageMeterBalances) {\n      balances.push(...experimental.usageMeterBalances)\n    }\n  }\n\n  return balances\n}\n\n/**\n * Hook to access usage meter balances for the current customer's subscriptions.\n *\n * Fetches usage meter balance data on mount. Can optionally filter by subscription ID.\n *\n * Must be used within a `FlowgladProvider`.\n *\n * @param params - Optional parameters\n * @param params.subscriptionId - Filter balances to a specific subscription\n *\n * @returns Object containing usage meter balances array, loading state, and error\n *\n * @example\n * ```tsx\n * function UsageDisplay() {\n *   const { usageMeters, isLoading, error } = useUsageMeters()\n *\n *   if (isLoading) return <Spinner />\n *   if (error) return <Error message={error.message} />\n *\n *   return (\n *     <div>\n *       {usageMeters?.map(meter => (\n *         <div key={meter.id}>\n *           {meter.name}: {meter.availableBalance}\n *         </div>\n *       ))}\n *     </div>\n *   )\n * }\n * ```\n */\nexport const useUsageMeters = (\n  params?: GetUsageMeterBalancesParams\n): UseUsageMetersResult => {\n  const {\n    baseURL,\n    betterAuthBasePath,\n    requestConfig,\n    __devMode,\n    billingMocks,\n  } = useFlowgladConfig()\n\n  const {\n    data: responseData,\n    isLoading,\n    error,\n  } = useQuery<UsageMeterBalancesRouteResponse, Error>({\n    queryKey: [USAGE_METERS_QUERY_KEY, params?.subscriptionId],\n    enabled: !__devMode,\n    queryFn: async () => {\n      const flowgladRoute = getFlowgladRoute(\n        baseURL,\n        betterAuthBasePath\n      )\n      const response = await fetch(\n        `${flowgladRoute}/${FlowgladActionKey.GetUsageMeterBalances}`,\n        {\n          method:\n            flowgladActionValidators[\n              FlowgladActionKey.GetUsageMeterBalances\n            ].method,\n          headers: {\n            'Content-Type': 'application/json',\n            ...requestConfig?.headers,\n          },\n          body: JSON.stringify(params ?? {}),\n        }\n      )\n\n      const json = await response.json()\n      return json as UsageMeterBalancesRouteResponse\n    },\n  })\n\n  // Dev mode: derive balances from billingMocks\n  if (__devMode) {\n    if (!billingMocks) {\n      throw new Error(\n        'FlowgladProvider: __devMode requires billingMocks'\n      )\n    }\n    const balances =\n      deriveUsageMeterBalancesFromBillingMocks(billingMocks)\n\n    // Apply subscriptionId filter if provided\n    const filteredBalances = params?.subscriptionId\n      ? balances.filter(\n          (b) => b.subscriptionId === params.subscriptionId\n        )\n      : balances\n\n    return {\n      usageMeters: filteredBalances,\n      isLoading: false,\n      error: null,\n    }\n  }\n\n  // Handle error responses from the API\n  if (responseData?.error) {\n    return {\n      usageMeters: undefined,\n      isLoading: false,\n      error: new Error(\n        responseData.error.json?.message?.toString() ??\n          responseData.error.code ??\n          'Failed to fetch usage meter balances'\n      ),\n    }\n  }\n\n  return {\n    usageMeters: responseData?.data?.usageMeterBalances,\n    isLoading,\n    error: error ?? null,\n  }\n}\n\n/**\n * Hook to access a specific usage meter balance by slug.\n *\n * This is a convenience wrapper around `useUsageMeters` that:\n * - Fetches all usage meter balances\n * - Filters to the specific meter by slug\n *\n * Uses the same query cache as `useUsageMeters`, preventing redundant API calls.\n *\n * Must be used within a `FlowgladProvider`.\n *\n * @param usageMeterSlug - The slug of the usage meter to access\n * @param params - Optional parameters\n * @param params.subscriptionId - Filter to a specific subscription\n *\n * @returns Object containing the usage meter balance, loading state, and error\n *\n * @example\n * ```tsx\n * function CreditBalance() {\n *   const { usageMeter, isLoading, error } = useUsageMeter('api-credits')\n *\n *   if (isLoading) return <Spinner />\n *   if (error) return <Error message={error.message} />\n *   if (!usageMeter) return <p>No credits found</p>\n *\n *   return <p>Available credits: {usageMeter.availableBalance}</p>\n * }\n * ```\n */\nexport const useUsageMeter = (\n  usageMeterSlug: string,\n  params?: GetUsageMeterBalancesParams\n): UseUsageMeterResult => {\n  const { usageMeters, isLoading, error } = useUsageMeters(params)\n  const usageMeter =\n    usageMeters?.find((b) => b.slug === usageMeterSlug) ?? null\n  return { usageMeter, isLoading, error }\n}\n"],"mappings":";;;;;AACA;AAAA,EAEE;AAAA,EACA;AAAA,OAIK;AACP,SAAS,gBAAgB;AACzB,SAAS,yBAAyB;AAClC,SAAS,wBAAwB;AAG1B,MAAM,yBAAyB;AAqCtC,MAAM,2CAA2C,CAC/C,iBACwB;AArD1B;AAsDE,QAAM,wBAAuB,kBAAa,yBAAb,YAAqC,CAAC;AACnE,QAAM,WAAgC,CAAC;AAEvC,aAAW,gBAAgB,sBAAsB;AAC/C,UAAM,eAAe,aAAa;AAClC,QAAI,6CAAc,oBAAoB;AACpC,eAAS,KAAK,GAAG,aAAa,kBAAkB;AAAA,IAClD;AAAA,EACF;AAEA,SAAO;AACT;AAkCO,MAAM,iBAAiB,CAC5B,WACyB;AArG3B;AAsGE,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,IAAI,kBAAkB;AAEtB,QAAM;AAAA,IACJ,MAAM;AAAA,IACN;AAAA,IACA;AAAA,EACF,IAAI,SAAiD;AAAA,IACnD,UAAU,CAAC,wBAAwB,iCAAQ,cAAc;AAAA,IACzD,SAAS,CAAC;AAAA,IACV,SAAS,MAAY;AACnB,YAAM,gBAAgB;AAAA,QACpB;AAAA,QACA;AAAA,MACF;AACA,YAAM,WAAW,MAAM;AAAA,QACrB,GAAG,aAAa,IAAI,kBAAkB,qBAAqB;AAAA,QAC3D;AAAA,UACE,QACE,yBACE,kBAAkB,qBACpB,EAAE;AAAA,UACJ,SAAS;AAAA,YACP,gBAAgB;AAAA,aACb,+CAAe;AAAA,UAEpB,MAAM,KAAK,UAAU,0BAAU,CAAC,CAAC;AAAA,QACnC;AAAA,MACF;AAEA,YAAM,OAAO,MAAM,SAAS,KAAK;AACjC,aAAO;AAAA,IACT;AAAA,EACF,CAAC;AAGD,MAAI,WAAW;AACb,QAAI,CAAC,cAAc;AACjB,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAAA,IACF;AACA,UAAM,WACJ,yCAAyC,YAAY;AAGvD,UAAM,oBAAmB,iCAAQ,kBAC7B,SAAS;AAAA,MACP,CAAC,MAAM,EAAE,mBAAmB,OAAO;AAAA,IACrC,IACA;AAEJ,WAAO;AAAA,MACL,aAAa;AAAA,MACb,WAAW;AAAA,MACX,OAAO;AAAA,IACT;AAAA,EACF;AAGA,MAAI,6CAAc,OAAO;AACvB,WAAO;AAAA,MACL,aAAa;AAAA,MACb,WAAW;AAAA,MACX,OAAO,IAAI;AAAA,SACT,oCAAa,MAAM,SAAnB,mBAAyB,YAAzB,mBAAkC,eAAlC,YACE,aAAa,MAAM,SADrB,YAEE;AAAA,MACJ;AAAA,IACF;AAAA,EACF;AAEA,SAAO;AAAA,IACL,cAAa,kDAAc,SAAd,mBAAoB;AAAA,IACjC;AAAA,IACA,OAAO,wBAAS;AAAA,EAClB;AACF;AAgCO,MAAM,gBAAgB,CAC3B,gBACA,WACwB;AA3N1B;AA4NE,QAAM,EAAE,aAAa,WAAW,MAAM,IAAI,eAAe,MAAM;AAC/D,QAAM,cACJ,gDAAa,KAAK,CAAC,MAAM,EAAE,SAAS,oBAApC,YAAuD;AACzD,SAAO,EAAE,YAAY,WAAW,MAAM;AACxC;","names":[]}