{"version":3,"sources":["../../src/FlowgladContext.tsx"],"sourcesContent":["'use client'\nimport type { Flowglad } from '@flowglad/node'\nimport {\n  type AdjustSubscriptionParams,\n  type BillingWithChecks,\n  type CancelSubscriptionParams,\n  type ClientCreateUsageEventParams,\n  type CreateActivateSubscriptionCheckoutSessionParams,\n  type CreateAddPaymentMethodCheckoutSessionParams,\n  type CreateProductCheckoutSessionParams,\n  type CustomerBillingDetails,\n  constructCheckFeatureAccess,\n  constructCheckUsageBalance,\n  constructGetPrice,\n  constructGetProduct,\n  constructHasPurchased,\n  FlowgladActionKey,\n  flowgladActionValidators,\n  type GetPricingModelResponse,\n  type PricingModel,\n  type UncancelSubscriptionParams,\n} from '@flowglad/shared'\nimport { useQuery, useQueryClient } from '@tanstack/react-query'\nimport { useMemo } from 'react'\nimport { useFlowgladConfig } from './FlowgladConfigContext'\nimport { devError } from './lib/utils'\nimport { USAGE_METERS_QUERY_KEY } from './useUsageMeters'\nimport { validateUrl } from './utils'\n\n/**\n * Constructs the base route for Flowglad API calls.\n *\n * @param baseURL - Optional base URL for the Flowglad API route handler\n * @param betterAuthBasePath - Optional Better Auth base path for routing through Better Auth endpoints\n * @returns The base route for Flowglad API calls\n *\n * When `betterAuthBasePath` is provided, routes are directed to Better Auth endpoints:\n * - e.g., `/api/auth/flowglad/customers/billing`\n *\n * When only `baseURL` is provided (or neither), routes use the standalone handler:\n * - e.g., `/api/flowglad/customers/billing`\n */\n// Export for testing\nexport const getFlowgladRoute = (\n  baseURL?: string,\n  betterAuthBasePath?: string\n): string => {\n  if (betterAuthBasePath) {\n    // Remove trailing slash to prevent malformed URLs like /api/auth//flowglad\n    const sanitizedPath = betterAuthBasePath\n      .trim()\n      .replace(/\\/+$/, '')\n    // Better Auth routes are under {basePath}/flowglad\n    return `${sanitizedPath}/flowglad`\n  }\n  const sanitizedBaseURL = baseURL?.trim() ?? ''\n  if (sanitizedBaseURL !== '') {\n    // Remove trailing slashes to prevent malformed URLs like https://x.com//api/flowglad\n    return `${sanitizedBaseURL.replace(/\\/+$/, '')}/api/flowglad`\n  }\n  return '/api/flowglad'\n}\n\nexport type FrontendProductCreateCheckoutSessionParams =\n  CreateProductCheckoutSessionParams & {\n    autoRedirect?: boolean\n  }\n\nexport type FrontendCreateAddPaymentMethodCheckoutSessionParams =\n  Omit<CreateAddPaymentMethodCheckoutSessionParams, 'type'> & {\n    autoRedirect?: boolean\n  }\n\nexport type FrontendCreateActivateSubscriptionCheckoutSessionParams =\n  Omit<CreateActivateSubscriptionCheckoutSessionParams, 'type'> & {\n    autoRedirect?: boolean\n  }\n\ntype CreateCheckoutSessionResponse =\n  | {\n      id: string\n      url: string\n    }\n  | { error: { code: string; json: Record<string, unknown> } }\n\nexport type LoadedFlowgladContextValues = BillingWithChecks & {\n  loaded: true\n  reload: () => Promise<void>\n  cancelSubscription: (params: CancelSubscriptionParams) => Promise<{\n    subscription: Flowglad.Subscriptions.SubscriptionCancelResponse\n  }>\n  uncancelSubscription: (\n    params: UncancelSubscriptionParams\n  ) => Promise<{\n    subscription: Flowglad.Subscriptions.SubscriptionUncancelResponse\n  }>\n  /**\n   * Adjust a subscription to a different price.\n   *\n   * @example\n   * // Simplest: adjust by price slug (quantity defaults to 1)\n   * await adjustSubscription({ priceSlug: 'pro-monthly' })\n   *\n   * // With quantity\n   * await adjustSubscription({ priceSlug: 'pro-monthly', quantity: 5 })\n   *\n   * // Using price ID\n   * await adjustSubscription({ priceId: 'price_abc123', quantity: 3 })\n   *\n   * // With timing override\n   * await adjustSubscription({\n   *   priceSlug: 'pro-monthly',\n   *   timing: 'at_end_of_current_billing_period'\n   * })\n   *\n   * // Explicit subscription ID (for multi-subscription customers)\n   * await adjustSubscription({\n   *   priceSlug: 'pro-monthly',\n   *   subscriptionId: 'sub_123'\n   * })\n   *\n   * // Complex adjustment with multiple items\n   * await adjustSubscription({\n   *   subscriptionItems: [\n   *     { priceSlug: 'base-plan', quantity: 1 },\n   *     { priceSlug: 'addon-storage', quantity: 3 },\n   *   ],\n   *   timing: 'immediately',\n   *   prorate: true,\n   * })\n   *\n   * @param params - Adjustment parameters (one of three forms)\n   * @param params.priceSlug - Adjust to a price by slug\n   * @param params.priceId - Adjust to a price by ID\n   * @param params.subscriptionItems - Array of items for multi-item adjustments\n   * @param params.quantity - Number of units (default: 1)\n   * @param params.subscriptionId - Subscription ID (auto-resolves if customer has exactly 1 subscription)\n   * @param params.timing - 'immediately' | 'at_end_of_current_billing_period' | 'auto' (default: 'auto')\n   * @param params.prorate - Whether to prorate (default: true for immediate, false for end-of-period)\n   */\n  adjustSubscription: (params: AdjustSubscriptionParams) => Promise<{\n    subscription: Flowglad.Subscriptions.SubscriptionAdjustResponse\n  }>\n  createCheckoutSession: (\n    params: FrontendProductCreateCheckoutSessionParams\n  ) => Promise<CreateCheckoutSessionResponse>\n  createAddPaymentMethodCheckoutSession: (\n    params: FrontendCreateAddPaymentMethodCheckoutSessionParams\n  ) => Promise<CreateCheckoutSessionResponse>\n  createActivateSubscriptionCheckoutSession: (\n    params: FrontendCreateActivateSubscriptionCheckoutSessionParams\n  ) => Promise<CreateCheckoutSessionResponse>\n  createUsageEvent: (\n    params: ClientCreateUsageEventParams\n  ) => Promise<\n    | { usageEvent: { id: string } }\n    | { error: { code: string; json: Record<string, unknown> } }\n  >\n  errors: null\n}\n\nexport interface NonPresentContextValues {\n  customer: null\n  subscriptions: null\n  createCheckoutSession: null\n  createAddPaymentMethodCheckoutSession: null\n  createActivateSubscriptionCheckoutSession: null\n  createUsageEvent: null\n  checkFeatureAccess: null\n  checkUsageBalance: null\n  hasPurchased: null\n  pricingModel: null\n  billingPortalUrl: null\n  reload: null\n  /**\n   * @deprecated Use `pricingModel` instead. This property is kept for backward compatibility.\n   */\n  catalog: null\n  invoices: []\n  paymentMethods: []\n  purchases: []\n  cancelSubscription: null\n  uncancelSubscription: null\n  adjustSubscription: null\n  currentSubscriptions: []\n  currentSubscription: null\n}\n\nexport interface NotLoadedFlowgladContextValues\n  extends NonPresentContextValues {\n  loaded: false\n  errors: null\n}\n\nexport interface NotAuthenticatedFlowgladContextValues\n  extends NonPresentContextValues {\n  loaded: true\n  errors: null\n}\n\nexport interface ErrorFlowgladContextValues\n  extends NonPresentContextValues {\n  loaded: true\n  errors: Error[]\n}\n\nexport type FlowgladContextValues =\n  | LoadedFlowgladContextValues\n  | NotLoadedFlowgladContextValues\n  | NotAuthenticatedFlowgladContextValues\n  | ErrorFlowgladContextValues\n\nconst notPresentContextValues: NonPresentContextValues = {\n  customer: null,\n  subscriptions: null,\n  createCheckoutSession: null,\n  createAddPaymentMethodCheckoutSession: null,\n  createActivateSubscriptionCheckoutSession: null,\n  createUsageEvent: null,\n  checkFeatureAccess: null,\n  checkUsageBalance: null,\n  hasPurchased: null,\n  pricingModel: null,\n  billingPortalUrl: null,\n  reload: null,\n  catalog: null,\n  invoices: [],\n  paymentMethods: [],\n  purchases: [],\n  cancelSubscription: null,\n  uncancelSubscription: null,\n  adjustSubscription: null,\n  currentSubscriptions: [],\n  currentSubscription: null,\n}\n\ntype CheckoutSessionParamsBase = {\n  successUrl: string\n  cancelUrl: string\n  autoRedirect?: boolean\n} & Record<string, unknown>\n\n// Builds a context-facing helper that hits a specific checkout session subroute,\n// while reusing shared validation, axios plumbing, and optional payload shaping.\nconst constructCheckoutSessionCreator =\n  <TParams extends CheckoutSessionParamsBase>(\n    actionKey: FlowgladActionKey,\n    baseURL: string | undefined,\n    betterAuthBasePath: string | undefined,\n    requestConfig?: RequestConfig,\n    mapPayload?: (\n      params: TParams,\n      basePayload: Omit<TParams, 'autoRedirect'>\n    ) => Record<string, unknown>\n  ) =>\n  async (params: TParams): Promise<CreateCheckoutSessionResponse> => {\n    validateUrl(params.successUrl, 'successUrl')\n    validateUrl(params.cancelUrl, 'cancelUrl')\n    if (baseURL) {\n      validateUrl(baseURL, 'baseURL', true)\n    }\n\n    const headers = requestConfig?.headers\n    const { autoRedirect, ...basePayload } = params\n    // The mapPayload hook lets each caller tweak the server payload without\n    // duplicating the core request logic.\n    const payload =\n      mapPayload?.(params, basePayload) ??\n      (basePayload as Record<string, unknown>)\n\n    const flowgladRoute = getFlowgladRoute(\n      baseURL,\n      betterAuthBasePath\n    )\n    const response = await fetch(`${flowgladRoute}/${actionKey}`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        ...headers,\n      },\n      body: JSON.stringify(payload),\n    })\n    const json: {\n      data: Flowglad.CheckoutSessions.CheckoutSessionCreateResponse\n      error?: { code: string; json: Record<string, unknown> }\n    } = await response.json()\n    const data = json.data\n    if (json.error) {\n      console.error(\n        'FlowgladContext: Checkout session creation failed',\n        json\n      )\n      return { error: json.error }\n    }\n    if (autoRedirect) {\n      window.location.href = data.url\n    }\n    return { id: data.checkoutSession.id, url: data.url }\n  }\n\ninterface ConstructCancelSubscriptionParams {\n  baseURL: string | undefined\n  betterAuthBasePath: string | undefined\n  requestConfig?: RequestConfig\n  queryClient: ReturnType<typeof useQueryClient>\n}\n\nconst constructCancelSubscription =\n  (constructParams: ConstructCancelSubscriptionParams) =>\n  async (\n    params: CancelSubscriptionParams\n  ): Promise<{\n    subscription: Flowglad.Subscriptions.SubscriptionCancelResponse\n  }> => {\n    const {\n      baseURL,\n      betterAuthBasePath,\n      requestConfig,\n      queryClient,\n    } = constructParams\n    const headers = requestConfig?.headers\n    const flowgladRoute = getFlowgladRoute(\n      baseURL,\n      betterAuthBasePath\n    )\n    const response = await fetch(\n      `${flowgladRoute}/${FlowgladActionKey.CancelSubscription}`,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...headers,\n        },\n        body: JSON.stringify(params),\n      }\n    )\n    const json: {\n      data: Flowglad.Subscriptions.SubscriptionCancelResponse\n      error?: { code: string; json: Record<string, unknown> }\n    } = await response.json()\n    const data = json.data\n    if (json.error) {\n      console.error(\n        'FlowgladContext: Subscription cancellation failed',\n        json\n      )\n    } else {\n      // Refetch customer billing after successful cancellation\n      await queryClient.invalidateQueries({\n        queryKey: [FlowgladActionKey.GetCustomerBilling],\n      })\n    }\n    return {\n      subscription: data,\n    }\n  }\n\ninterface ConstructUncancelSubscriptionParams {\n  baseURL: string | undefined\n  betterAuthBasePath: string | undefined\n  requestConfig?: RequestConfig\n  queryClient: ReturnType<typeof useQueryClient>\n}\n\nconst constructUncancelSubscription =\n  (constructParams: ConstructUncancelSubscriptionParams) =>\n  async (\n    params: UncancelSubscriptionParams\n  ): Promise<{\n    subscription: Flowglad.Subscriptions.SubscriptionUncancelResponse\n  }> => {\n    const {\n      baseURL,\n      betterAuthBasePath,\n      requestConfig,\n      queryClient,\n    } = constructParams\n    const headers = requestConfig?.headers\n    const flowgladRoute = getFlowgladRoute(\n      baseURL,\n      betterAuthBasePath\n    )\n    const response = await fetch(\n      `${flowgladRoute}/${FlowgladActionKey.UncancelSubscription}`,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...headers,\n        },\n        body: JSON.stringify(params),\n      }\n    )\n    const json: {\n      data: Flowglad.Subscriptions.SubscriptionUncancelResponse\n      error?: { code: string; json: Record<string, unknown> }\n    } = await response.json()\n    const data = json.data\n    if (json.error) {\n      console.error(\n        'FlowgladContext: Subscription uncancellation failed',\n        json\n      )\n    } else {\n      // Refetch customer billing after successful uncancellation\n      await queryClient.invalidateQueries({\n        queryKey: [FlowgladActionKey.GetCustomerBilling],\n      })\n    }\n    return {\n      subscription: data,\n    }\n  }\n\ninterface ConstructAdjustSubscriptionParams {\n  baseURL: string | undefined\n  betterAuthBasePath: string | undefined\n  requestConfig?: RequestConfig\n  queryClient: ReturnType<typeof useQueryClient>\n  currentSubscriptions:\n    | CustomerBillingDetails['currentSubscriptions']\n    | null\n}\n\nconst constructAdjustSubscription =\n  (constructParams: ConstructAdjustSubscriptionParams) =>\n  async (\n    params: AdjustSubscriptionParams\n  ): Promise<{\n    subscription: Flowglad.Subscriptions.SubscriptionAdjustResponse\n  }> => {\n    const {\n      baseURL,\n      betterAuthBasePath,\n      requestConfig,\n      queryClient,\n      currentSubscriptions,\n    } = constructParams\n    const headers = requestConfig?.headers\n    const flowgladRoute = getFlowgladRoute(\n      baseURL,\n      betterAuthBasePath\n    )\n\n    // Auto-resolve subscriptionId if not provided\n    let subscriptionId = params.subscriptionId\n    if (!subscriptionId) {\n      if (\n        !currentSubscriptions ||\n        currentSubscriptions.length === 0\n      ) {\n        throw new Error(\n          'No active subscription found for this customer'\n        )\n      }\n      if (currentSubscriptions.length > 1) {\n        throw new Error(\n          'Customer has multiple active subscriptions. Please specify subscriptionId in params.'\n        )\n      }\n      subscriptionId = currentSubscriptions[0].id\n    }\n\n    const response = await fetch(\n      `${flowgladRoute}/${FlowgladActionKey.AdjustSubscription}`,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...headers,\n        },\n        body: JSON.stringify({\n          ...params,\n          subscriptionId,\n        }),\n      }\n    )\n\n    if (!response.ok) {\n      throw new Error(\n        `Subscription adjustment failed: ${response.status} ${response.statusText}`\n      )\n    }\n\n    const json: {\n      data?: Flowglad.Subscriptions.SubscriptionAdjustResponse\n      error?: { code: string; json: Record<string, unknown> }\n    } = await response.json()\n\n    if (json.error) {\n      console.error(\n        'FlowgladContext: Subscription adjustment failed',\n        json\n      )\n      throw new Error(\n        json.error.code ?? 'Subscription adjustment failed'\n      )\n    }\n\n    if (!json.data) {\n      throw new Error(\n        'Subscription adjustment failed: no data returned'\n      )\n    }\n\n    // Refetch customer billing after successful adjustment\n    await queryClient.invalidateQueries({\n      queryKey: [FlowgladActionKey.GetCustomerBilling],\n    })\n\n    return {\n      subscription: json.data,\n    }\n  }\n\ninterface ConstructCreateUsageEventParams {\n  baseURL: string | undefined\n  betterAuthBasePath: string | undefined\n  requestConfig?: RequestConfig\n  queryClient: ReturnType<typeof useQueryClient>\n}\n\nconst constructCreateUsageEvent =\n  (constructParams: ConstructCreateUsageEventParams) =>\n  async (\n    params: ClientCreateUsageEventParams\n  ): Promise<\n    | { usageEvent: { id: string } }\n    | { error: { code: string; json: Record<string, unknown> } }\n  > => {\n    const {\n      baseURL,\n      betterAuthBasePath,\n      requestConfig,\n      queryClient,\n    } = constructParams\n    const headers = requestConfig?.headers\n    const flowgladRoute = getFlowgladRoute(\n      baseURL,\n      betterAuthBasePath\n    )\n\n    const response = await fetch(\n      `${flowgladRoute}/${FlowgladActionKey.CreateUsageEvent}`,\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...headers,\n        },\n        body: JSON.stringify(params),\n      }\n    )\n\n    const json = await response.json()\n    if (json.error) {\n      console.error(\n        'FlowgladContext: Usage event creation failed',\n        json\n      )\n      return { error: json.error }\n    }\n\n    // Invalidate usage meter query key after successful creation\n    await queryClient.invalidateQueries({\n      queryKey: [USAGE_METERS_QUERY_KEY],\n    })\n\n    return { usageEvent: { id: json.data.usageEvent.id } }\n  }\n\n/**\n * Configuration for all requests made to the Flowglad API\n * route.\n */\nexport interface RequestConfig {\n  baseURL?: string\n  headers?: Record<string, string>\n  /**\n   * Custom fetch implementation for React Native compatibility.\n   * If not provided, falls back to global fetch.\n   * Required in React Native environments where global fetch may not be available.\n   */\n  fetch?: typeof fetch\n}\n\ntype CustomerBillingRouteResponse = {\n  data?: CustomerBillingDetails | null\n  error?: { message: string } | null\n}\n\ntype PricingModelRouteResponse = {\n  data?: GetPricingModelResponse | null\n  error?: { code: string; json: Record<string, unknown> } | null\n}\n\nconst getFetchImpl = (requestConfig?: RequestConfig) => {\n  const fetchImpl =\n    requestConfig?.fetch ??\n    (typeof fetch !== 'undefined' ? fetch : undefined)\n  if (!fetchImpl) {\n    throw new Error(\n      'fetch is not available. In React Native environments, provide a fetch implementation via requestConfig.fetch'\n    )\n  }\n  return fetchImpl\n}\n\nconst hasDataOrError = (\n  value: unknown\n): value is { data?: unknown; error?: unknown } => {\n  if (typeof value !== 'object' || value === null) {\n    return false\n  }\n  return 'data' in value || 'error' in value\n}\n\nconst isCustomerBillingRouteResponse = (\n  value: unknown\n): value is CustomerBillingRouteResponse => {\n  return hasDataOrError(value)\n}\n\nconst isPricingModelRouteResponse = (\n  value: unknown\n): value is PricingModelRouteResponse => {\n  return hasDataOrError(value)\n}\n\n// Export for testing\ninterface FetchFlowgladParams {\n  baseURL?: string\n  betterAuthBasePath?: string\n  requestConfig?: RequestConfig\n}\n\nexport const fetchCustomerBilling = async ({\n  baseURL,\n  betterAuthBasePath,\n  requestConfig,\n}: FetchFlowgladParams): Promise<CustomerBillingRouteResponse> => {\n  const fetchImpl = getFetchImpl(requestConfig)\n\n  const flowgladRoute = getFlowgladRoute(baseURL, betterAuthBasePath)\n  const response = await fetchImpl(\n    `${flowgladRoute}/${FlowgladActionKey.GetCustomerBilling}`,\n    {\n      method:\n        flowgladActionValidators[FlowgladActionKey.GetCustomerBilling]\n          .method,\n      body: JSON.stringify({}),\n      headers: {\n        'Content-Type': 'application/json',\n        ...requestConfig?.headers,\n      },\n    }\n  )\n\n  try {\n    const data: unknown = await response.json()\n    if (isCustomerBillingRouteResponse(data)) {\n      return data\n    }\n    return {\n      data: null,\n      error: { message: 'Unexpected billing response shape' },\n    }\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Flowglad: Error fetching billing:', error)\n    }\n    return {\n      data: null,\n      error: { message: 'Failed to parse billing response JSON' },\n    }\n  }\n}\n\nexport const fetchPricingModel = async ({\n  baseURL,\n  betterAuthBasePath,\n  requestConfig,\n}: FetchFlowgladParams): Promise<PricingModelRouteResponse> => {\n  const fetchImpl = getFetchImpl(requestConfig)\n  const flowgladRoute = getFlowgladRoute(baseURL, betterAuthBasePath)\n  const response = await fetchImpl(\n    `${flowgladRoute}/${FlowgladActionKey.GetPricingModel}`,\n    {\n      method:\n        flowgladActionValidators[FlowgladActionKey.GetPricingModel]\n          .method,\n      body: JSON.stringify({}),\n      headers: {\n        'Content-Type': 'application/json',\n        ...requestConfig?.headers,\n      },\n    }\n  )\n\n  try {\n    const data: unknown = await response.json()\n    if (isPricingModelRouteResponse(data)) {\n      return data\n    }\n    return {\n      data: null,\n      error: {\n        code: 'UNEXPECTED_PRICING_MODEL_RESPONSE',\n        json: {\n          message: 'Unexpected pricing model response shape',\n        },\n      },\n    }\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Flowglad: Error fetching pricing model:', error)\n    }\n    return {\n      data: null,\n      error: {\n        code: 'PRICING_MODEL_JSON_PARSE_FAILED',\n        json: {\n          message: 'Failed to parse pricing model response JSON',\n        },\n      },\n    }\n  }\n}\n\nconst getDevModeBillingMocks = (\n  billingMocks: CustomerBillingDetails | undefined\n) => {\n  if (!billingMocks) {\n    throw new Error(\n      'FlowgladProvider: __devMode requires billingMocks'\n    )\n  }\n  return billingMocks\n}\n\nconst buildDevModeBillingValue = (\n  billingData: CustomerBillingDetails\n): LoadedFlowgladContextValues => {\n  const getProduct = constructGetProduct(billingData.pricingModel)\n  const getPrice = constructGetPrice(billingData.pricingModel)\n  const checkFeatureAccess = constructCheckFeatureAccess(\n    billingData.currentSubscriptions ?? []\n  )\n  const checkUsageBalance = constructCheckUsageBalance(\n    billingData.currentSubscriptions ?? []\n  )\n  const hasPurchased = constructHasPurchased(\n    billingData.pricingModel,\n    billingData.purchases\n  )\n\n  return {\n    loaded: true,\n    errors: null,\n    createCheckoutSession: () =>\n      Promise.resolve({\n        id: 'checkout-session-id',\n        url: '',\n      }),\n    createAddPaymentMethodCheckoutSession: () =>\n      Promise.resolve({\n        id: 'checkout-session-id',\n        url: '',\n      }),\n    createActivateSubscriptionCheckoutSession: () =>\n      Promise.resolve({\n        id: 'checkout-session-id',\n        url: '',\n      }),\n    cancelSubscription: (params: CancelSubscriptionParams) => {\n      const subscription =\n        billingData.currentSubscriptions?.find(\n          (sub) => sub.id === params.id\n        ) ??\n        billingData.currentSubscription ??\n        billingData.subscriptions?.find((sub) => sub.id === params.id)\n      if (!subscription) {\n        return Promise.reject(\n          new Error(\n            `Dev mode: no subscription found for id \"${params.id}\"`\n          )\n        )\n      }\n\n      const now = Date.now()\n      return Promise.resolve({\n        subscription: {\n          subscription: {\n            ...subscription,\n            current: false,\n            status: 'canceled',\n            canceledAt: now,\n            cancelScheduledAt: null,\n            updatedAt: now,\n          },\n        },\n      })\n    },\n    uncancelSubscription: (params: UncancelSubscriptionParams) => {\n      const subscription =\n        billingData.currentSubscriptions?.find(\n          (sub) => sub.id === params.id\n        ) ??\n        billingData.currentSubscription ??\n        billingData.subscriptions?.find((sub) => sub.id === params.id)\n      if (!subscription) {\n        return Promise.reject(\n          new Error(\n            `Dev mode: no subscription found for id \"${params.id}\"`\n          )\n        )\n      }\n\n      const now = Date.now()\n      return Promise.resolve({\n        subscription: {\n          subscription: {\n            ...subscription,\n            current: true,\n            status: 'active',\n            canceledAt: null,\n            cancelScheduledAt: null,\n            updatedAt: now,\n          },\n        },\n      })\n    },\n    adjustSubscription: (params: AdjustSubscriptionParams) => {\n      // In dev mode, auto-resolve subscriptionId\n      let subscriptionId = params.subscriptionId\n      if (!subscriptionId) {\n        const currentSubs = billingData.currentSubscriptions ?? []\n        if (currentSubs.length === 0) {\n          return Promise.reject(\n            new Error(\n              'Dev mode: no active subscription found for this customer'\n            )\n          )\n        }\n        if (currentSubs.length > 1) {\n          return Promise.reject(\n            new Error(\n              'Dev mode: customer has multiple active subscriptions. Please specify subscriptionId in params.'\n            )\n          )\n        }\n        subscriptionId = currentSubs[0].id\n      }\n\n      const subscription =\n        billingData.currentSubscriptions?.find(\n          (sub) => sub.id === subscriptionId\n        ) ??\n        billingData.currentSubscription ??\n        billingData.subscriptions?.find(\n          (sub) => sub.id === subscriptionId\n        )\n      if (!subscription) {\n        return Promise.reject(\n          new Error(\n            `Dev mode: no subscription found for id \"${subscriptionId}\"`\n          )\n        )\n      }\n\n      const now = Date.now()\n      // Note: In dev mode, subscriptionItems returns an empty array.\n      // The real API returns the updated subscription items after adjustment.\n      return Promise.resolve({\n        subscription: {\n          subscription: {\n            ...subscription,\n            updatedAt: now,\n          },\n          subscriptionItems: [],\n          isUpgrade: false,\n          resolvedTiming: 'immediately',\n        },\n      })\n    },\n    createUsageEvent: () =>\n      Promise.resolve({\n        usageEvent: { id: 'dev-usage-event-id' },\n      }),\n    checkFeatureAccess,\n    checkUsageBalance,\n    hasPurchased,\n    getProduct,\n    getPrice,\n    reload: () => Promise.resolve(),\n    customer: billingData.customer,\n    subscriptions: billingData.subscriptions,\n    purchases: billingData.purchases,\n    invoices: billingData.invoices,\n    paymentMethods: billingData.paymentMethods,\n    currentSubscription: billingData.currentSubscription,\n    currentSubscriptions: billingData.currentSubscriptions,\n    billingPortalUrl: billingData.billingPortalUrl,\n    pricingModel: billingData.pricingModel,\n    // catalog is kept for SDK type compatibility (same data as pricingModel)\n    catalog: billingData.catalog,\n  }\n}\n\n/**\n * Hook to access billing data and actions for the current authenticated customer.\n *\n * Automatically fetches billing data when mounted. The hook returns loading state,\n * customer information, subscriptions, and action functions for managing billing.\n *\n * @returns {FlowgladContextValues} The billing context including:\n *   - `loaded`: Whether billing data has been fetched\n *   - `errors`: Any errors that occurred during fetch\n *   - `customer`: The customer object (null if not authenticated)\n *   - `subscriptions`: Array of customer subscriptions\n *   - `currentSubscription`: The primary active subscription\n *   - `pricingModel`: The pricing model with products and prices\n *   - Action functions: `createCheckoutSession`, `cancelSubscription`, `adjustSubscription`, etc.\n *\n * @example\n * ```tsx\n * function BillingPage() {\n *   const billing = useBilling()\n *\n *   if (!billing.loaded) return <Loading />\n *   if (billing.errors) return <Error errors={billing.errors} />\n *   if (!billing.customer) return <SignInPrompt />\n *\n *   return <SubscriptionDetails subscription={billing.currentSubscription} />\n * }\n * ```\n */\nexport const useBilling = (): FlowgladContextValues => {\n  const queryClient = useQueryClient()\n  const {\n    baseURL,\n    betterAuthBasePath,\n    requestConfig,\n    __devMode,\n    billingMocks,\n  } = useFlowgladConfig()\n\n  // Billing fetch only occurs when this hook is mounted.\n  const {\n    isPending: isPendingBilling,\n    error: errorBilling,\n    data: billing,\n  } = useQuery<CustomerBillingRouteResponse, Error>({\n    queryKey: [FlowgladActionKey.GetCustomerBilling],\n    enabled: !__devMode,\n    queryFn: () =>\n      fetchCustomerBilling({\n        baseURL,\n        betterAuthBasePath,\n        requestConfig,\n      }),\n  })\n\n  if (__devMode) {\n    const billingData = getDevModeBillingMocks(billingMocks)\n    return buildDevModeBillingValue(billingData)\n  }\n\n  // Each handler below gets its own Flowglad subroute, but still funnels through\n  // the shared creator for validation and redirect behavior.\n  const createCheckoutSession = useMemo(\n    () =>\n      constructCheckoutSessionCreator<FrontendProductCreateCheckoutSessionParams>(\n        FlowgladActionKey.CreateCheckoutSession,\n        baseURL,\n        betterAuthBasePath,\n        requestConfig,\n        (_, basePayload) => ({\n          ...basePayload,\n          type: 'product',\n        })\n      ),\n    [baseURL, betterAuthBasePath, requestConfig]\n  )\n\n  const createAddPaymentMethodCheckoutSession = useMemo(\n    () =>\n      constructCheckoutSessionCreator<FrontendCreateAddPaymentMethodCheckoutSessionParams>(\n        FlowgladActionKey.CreateAddPaymentMethodCheckoutSession,\n        baseURL,\n        betterAuthBasePath,\n        requestConfig\n      ),\n    [baseURL, betterAuthBasePath, requestConfig]\n  )\n\n  const createActivateSubscriptionCheckoutSession = useMemo(\n    () =>\n      constructCheckoutSessionCreator<FrontendCreateActivateSubscriptionCheckoutSessionParams>(\n        FlowgladActionKey.CreateActivateSubscriptionCheckoutSession,\n        baseURL,\n        betterAuthBasePath,\n        requestConfig\n      ),\n    [baseURL, betterAuthBasePath, requestConfig]\n  )\n\n  const cancelSubscription = useMemo(\n    () =>\n      constructCancelSubscription({\n        baseURL,\n        betterAuthBasePath,\n        requestConfig,\n        queryClient,\n      }),\n    [baseURL, betterAuthBasePath, requestConfig, queryClient]\n  )\n\n  const uncancelSubscription = useMemo(\n    () =>\n      constructUncancelSubscription({\n        baseURL,\n        betterAuthBasePath,\n        requestConfig,\n        queryClient,\n      }),\n    [baseURL, betterAuthBasePath, requestConfig, queryClient]\n  )\n\n  const createUsageEvent = useMemo(\n    () =>\n      constructCreateUsageEvent({\n        baseURL,\n        betterAuthBasePath,\n        requestConfig,\n        queryClient,\n      }),\n    [baseURL, betterAuthBasePath, requestConfig, queryClient]\n  )\n\n  const adjustSubscription = useMemo(\n    () =>\n      constructAdjustSubscription({\n        baseURL,\n        betterAuthBasePath,\n        requestConfig,\n        queryClient,\n        currentSubscriptions:\n          billing?.data?.currentSubscriptions ?? null,\n      }),\n    [\n      baseURL,\n      betterAuthBasePath,\n      requestConfig,\n      queryClient,\n      billing?.data?.currentSubscriptions,\n    ]\n  )\n\n  if (billing) {\n    const billingError = billing.error\n    const errors: Error[] = []\n    if (billingError) {\n      devError(\n        `Flowglad route handler error: ${billingError.message}`\n      )\n      errors.push(new Error(billingError.message))\n    }\n    if (billing.data) {\n      const billingData: CustomerBillingDetails = billing.data\n      const reload = async () => {\n        await queryClient.invalidateQueries({\n          queryKey: [FlowgladActionKey.GetCustomerBilling],\n        })\n      }\n      const getProduct = constructGetProduct(billingData.pricingModel)\n      const getPrice = constructGetPrice(billingData.pricingModel)\n      const hasPurchased = constructHasPurchased(\n        billingData.pricingModel,\n        billingData.purchases\n      )\n      return {\n        loaded: true,\n        customer: billingData.customer,\n        createCheckoutSession,\n        createAddPaymentMethodCheckoutSession,\n        cancelSubscription,\n        uncancelSubscription,\n        adjustSubscription,\n        createActivateSubscriptionCheckoutSession,\n        createUsageEvent,\n        getProduct,\n        getPrice,\n        hasPurchased,\n        checkFeatureAccess: constructCheckFeatureAccess(\n          billingData.currentSubscriptions ?? []\n        ),\n        checkUsageBalance: constructCheckUsageBalance(\n          billingData.currentSubscriptions ?? []\n        ),\n        subscriptions: billingData.subscriptions,\n        purchases: billingData.purchases,\n        errors: null,\n        reload,\n        invoices: billingData.invoices,\n        paymentMethods: billingData.paymentMethods,\n        currentSubscription: billingData.currentSubscription,\n        currentSubscriptions: billingData.currentSubscriptions,\n        billingPortalUrl: billingData.billingPortalUrl,\n        pricingModel: billingData.pricingModel,\n        // catalog is kept for SDK type compatibility (same data as pricingModel)\n        catalog: billingData.catalog,\n      }\n    }\n\n    if (errors.length > 0) {\n      return {\n        loaded: true,\n        errors,\n        ...notPresentContextValues,\n      }\n    }\n\n    return {\n      loaded: true,\n      errors: null,\n      ...notPresentContextValues,\n    }\n  }\n\n  if (isPendingBilling) {\n    return {\n      loaded: false,\n      errors: null,\n      ...notPresentContextValues,\n    }\n  }\n\n  const errors: Error[] = [errorBilling].filter(\n    (error): error is Error => error !== null\n  )\n\n  if (errors.length > 0) {\n    return {\n      loaded: true,\n      errors,\n      ...notPresentContextValues,\n    }\n  }\n\n  return {\n    loaded: true,\n    errors: null,\n    ...notPresentContextValues,\n  }\n}\n\n/**\n * Hook to fetch public pricing data without requiring authentication.\n *\n * Unlike `useBilling`, this hook fetches only the pricing model (products and prices)\n * from a public endpoint. Use this for pricing pages that should be visible to\n * unauthenticated users.\n *\n * @returns {PricingModel | null} The pricing model containing products, prices, and\n *   usage meters, or null while loading or if unavailable.\n *\n * @example\n * ```tsx\n * function PricingPage() {\n *   const pricingModel = usePricingModel()\n *\n *   if (!pricingModel) return <Loading />\n *\n *   return (\n *     <div>\n *       {pricingModel.products.map(product => (\n *         <PricingCard key={product.id} product={product} />\n *       ))}\n *     </div>\n *   )\n * }\n * ```\n */\nexport const usePricingModel = (): PricingModel | null => {\n  const {\n    baseURL,\n    betterAuthBasePath,\n    requestConfig,\n    __devMode,\n    billingMocks,\n  } = useFlowgladConfig()\n\n  const { data: pricingData, error: pricingError } = useQuery<\n    PricingModelRouteResponse,\n    Error\n  >({\n    queryKey: [FlowgladActionKey.GetPricingModel],\n    enabled: !__devMode,\n    queryFn: () =>\n      fetchPricingModel({\n        baseURL,\n        betterAuthBasePath,\n        requestConfig,\n      }),\n  })\n\n  if (__devMode) {\n    const billingData = getDevModeBillingMocks(billingMocks)\n    return billingData.pricingModel\n  }\n\n  if (pricingError) {\n    devError(`Flowglad route handler error: ${pricingError.message}`)\n    return null\n  }\n\n  if (pricingData?.error) {\n    devError(\n      `Flowglad route handler error: ${pricingData.error.code}`\n    )\n    return null\n  }\n\n  return pricingData?.data?.pricingModel ?? null\n}\n\n/**\n * Alias for `usePricingModel`.\n *\n * This is a convenience alias for developers who prefer a shorter hook name.\n * Functionally identical to `usePricingModel`.\n *\n * @returns {PricingModel | null} The pricing model, or null while loading or if unavailable.\n * @see usePricingModel\n */\nexport const usePricing = () => usePricingModel()\n"],"mappings":"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","names":["import_utils","_a","_b","errors"]}