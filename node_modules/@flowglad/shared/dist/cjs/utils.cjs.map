{"version":3,"sources":["../../src/utils.ts"],"sourcesContent":["import type { Flowglad as FlowgladNode } from '@flowglad/node'\nimport type {\n  SubscriptionExperimentalFields,\n  UsageMeterBalance,\n} from './types/sdk'\n\nconst IS_DEV = process.env.NODE_ENV === 'development'\n\nexport const getBaseURL = () => {\n  // allow override in dev\n  if (IS_DEV && process.env.FLOWGLAD_API_URL_OVERRIDE) {\n    return process.env.FLOWGLAD_API_URL_OVERRIDE\n  }\n  return 'https://app.flowglad.com'\n}\n\nexport const constructCheckFeatureAccess = (\n  subscriptions: {\n    id: string\n    experimental?: SubscriptionExperimentalFields\n  }[]\n) => {\n  const checkFeatureAccess = (\n    featureSlug: string,\n    refinementParams?: {\n      subscriptionId?: string\n    }\n  ): boolean => {\n    const subscription = refinementParams?.subscriptionId\n      ? subscriptions.find(\n          (s) => s.id === refinementParams.subscriptionId\n        )\n      : subscriptions[0]\n    if (!subscription) {\n      return false\n    }\n    const experimental = subscription.experimental\n    const featureItemsBySlug =\n      experimental?.featureItems.reduce(\n        (\n          acc: Record<\n            string,\n            SubscriptionExperimentalFields['featureItems'][number]\n          >,\n          featureItem: SubscriptionExperimentalFields['featureItems'][number]\n        ) => {\n          if (featureItem.type === 'toggle') {\n            acc[featureItem.slug] = featureItem\n          }\n          return acc\n        },\n        {} as Record<\n          string,\n          SubscriptionExperimentalFields['featureItems'][number]\n        >\n      ) ?? {}\n    const featureItem = featureItemsBySlug[featureSlug]\n    if (!featureItem) {\n      return false\n    }\n    return featureItem.type === 'toggle'\n  }\n  return checkFeatureAccess\n}\n\nexport const constructCheckUsageBalance = (\n  subscriptions: {\n    id: string\n    experimental?: SubscriptionExperimentalFields\n  }[]\n) => {\n  const checkUsageBalance = (\n    usageMeterSlug: string,\n    refinementParams?: {\n      subscriptionId?: string\n    }\n  ): {\n    availableBalance: number\n  } | null => {\n    const subscription = refinementParams?.subscriptionId\n      ? subscriptions.find(\n          (s) => s.id === refinementParams.subscriptionId\n        )\n      : subscriptions[0]\n    if (!subscription) {\n      return null\n    }\n    const experimental = subscription.experimental\n    const usageMeterBalancesBySlug =\n      experimental?.usageMeterBalances.reduce(\n        (\n          acc: Record<string, UsageMeterBalance>,\n          usageMeterBalance: UsageMeterBalance\n        ) => {\n          acc[usageMeterBalance.slug] = usageMeterBalance\n          return acc\n        },\n        {} as Record<string, UsageMeterBalance>\n      ) ?? {}\n    const usageMeterBalance = usageMeterBalancesBySlug[usageMeterSlug]\n    if (!usageMeterBalance) {\n      return null\n    }\n    return usageMeterBalance\n  }\n  return checkUsageBalance\n}\n\nexport const constructGetProduct = (\n  pricingModel: FlowgladNode.CustomerRetrieveBillingResponse['pricingModel']\n) => {\n  const productsBySlug = new Map(\n    pricingModel.products.map((product) => [product.slug, product])\n  )\n  const getProduct = (productSlug: string) => {\n    return productsBySlug.get(productSlug) ?? null\n  }\n  return getProduct\n}\n\nexport const constructGetPrice = (\n  pricingModel: FlowgladNode.CustomerRetrieveBillingResponse['pricingModel']\n) => {\n  type Price =\n    FlowgladNode.CustomerRetrieveBillingResponse['pricingModel']['products'][number]['prices'][number]\n\n  // Collect all prices from products (includes subscription, single payment, and usage prices)\n  const allPrices: Array<readonly [string | null, Price]> =\n    pricingModel.products.flatMap((product) =>\n      product.prices.map((price) => [price.slug, price] as const)\n    )\n\n  const pricesBySlug = new Map<string | null, Price>(allPrices)\n\n  const getPrice = (priceSlug: string): Price | null => {\n    return pricesBySlug.get(priceSlug) ?? null\n  }\n  return getPrice\n}\n\nexport const constructHasPurchased = (\n  pricingModel: FlowgladNode.CustomerRetrieveBillingResponse['pricingModel'],\n  purchases: FlowgladNode.CustomerRetrieveBillingResponse['purchases']\n) => {\n  const productsBySlug = new Map(\n    pricingModel.products.map((product) => [product.slug, product])\n  )\n\n  // Create a set of all purchased price IDs for quick lookup\n  const purchasedPriceIds = new Set(\n    (purchases ?? []).map((purchase) => purchase.priceId)\n  )\n\n  /**\n   * @experimental\n   * Checks if a customer has purchased a specific product, based on the product's slug\n   * @param productSlug - The slug of the product to check\n   * @returns True if the customer has purchased the product, false otherwise\n   */\n  const hasPurchased = (productSlug: string): boolean => {\n    const product = productsBySlug.get(productSlug)\n\n    if (!product) {\n      return false\n    }\n\n    // Check if any of the product's prices have been purchased\n    return product.prices.some((price) =>\n      purchasedPriceIds.has(price.id)\n    )\n  }\n\n  return hasPurchased\n}\n"],"mappings":"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","names":["featureItem","usageMeterBalance"]}