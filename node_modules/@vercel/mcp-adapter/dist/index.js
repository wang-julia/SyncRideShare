'use strict';

var chunkVNDCGWQ6_js = require('./chunk-VNDCGWQ6.js');
var chunkUILOG6SR_js = require('./chunk-UILOG6SR.js');
var errors_js = require('@modelcontextprotocol/sdk/server/auth/errors.js');

function withMcpAuth(handler, verifyToken, {
  required = false,
  resourceMetadataPath = "/.well-known/oauth-protected-resource",
  requiredScopes
} = {}) {
  return (req) => chunkUILOG6SR_js.__async(this, null, function* () {
    try {
      const authHeader = req.headers.get("Authorization");
      const [type, token] = (authHeader == null ? void 0 : authHeader.split(" ")) || [];
      const bearerToken = (type == null ? void 0 : type.toLowerCase()) === "bearer" ? token : void 0;
      const authInfo = yield verifyToken(req, bearerToken);
      if (required && !authInfo) {
        throw new errors_js.InvalidTokenError("No authorization provided");
      }
      if (!authInfo) {
        return handler(req);
      }
      if (requiredScopes == null ? void 0 : requiredScopes.length) {
        const hasAllScopes = requiredScopes.every(
          (scope) => authInfo.scopes.includes(scope)
        );
        if (!hasAllScopes) {
          throw new errors_js.InsufficientScopeError("Insufficient scope");
        }
      }
      if (authInfo.expiresAt && authInfo.expiresAt < Date.now() / 1e3) {
        throw new errors_js.InvalidTokenError("Token has expired");
      }
      req.auth = authInfo;
      return chunkVNDCGWQ6_js.withAuthContext(authInfo, () => handler(req));
    } catch (error) {
      const origin = new URL(req.url).origin;
      const resourceMetadataUrl = `${origin}${resourceMetadataPath}`;
      if (error instanceof errors_js.InvalidTokenError) {
        return new Response(JSON.stringify(error.toResponseObject()), {
          status: 401,
          headers: {
            "WWW-Authenticate": `Bearer error="${error.errorCode}", error_description="${error.message}", resource_metadata="${resourceMetadataUrl}"`,
            "Content-Type": "application/json"
          }
        });
      } else if (error instanceof errors_js.InsufficientScopeError) {
        return new Response(JSON.stringify(error.toResponseObject()), {
          status: 403,
          headers: {
            "WWW-Authenticate": `Bearer error="${error.errorCode}", error_description="${error.message}", resource_metadata="${resourceMetadataUrl}"`,
            "Content-Type": "application/json"
          }
        });
      } else if (error instanceof errors_js.ServerError) {
        return new Response(JSON.stringify(error.toResponseObject()), {
          status: 500,
          headers: {
            "Content-Type": "application/json"
          }
        });
      } else {
        console.error("Unexpected error authenticating bearer token:", error);
        const serverError = new errors_js.ServerError("Internal Server Error");
        return new Response(JSON.stringify(serverError.toResponseObject()), {
          status: 500,
          headers: {
            "Content-Type": "application/json"
          }
        });
      }
    }
  });
}

Object.defineProperty(exports, "createMcpHandler", {
  enumerable: true,
  get: function () { return chunkVNDCGWQ6_js.createMcpRouteHandler; }
});
exports.experimental_withMcpAuth = withMcpAuth;
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map