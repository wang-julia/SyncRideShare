{"version":3,"sources":["../src/next/auth-wrapper.ts"],"names":[],"mappings":";;;;;;;;;AACA;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,OACK;AASA,SAAS,YACd,SACA,aAIA;AAAA,EACE,WAAW;AAAA,EACX,uBAAuB;AAAA,EACvB;AACF,IAII,CAAC,GACL;AACA,SAAO,CAAO,QAAiB;AAC7B,QAAI;AACF,YAAM,aAAa,IAAI,QAAQ,IAAI,eAAe;AAClD,YAAM,CAAC,MAAM,KAAK,KAAI,yCAAY,MAAM,SAAQ,CAAC;AAIjD,YAAM,eAAc,6BAAM,mBAAkB,WAAW,QAAQ;AAE/D,YAAM,WAAW,MAAM,YAAY,KAAK,WAAW;AAEnD,UAAI,YAAY,CAAC,UAAU;AACzB,cAAM,IAAI,kBAAkB,2BAA2B;AAAA,MACzD;AAEA,UAAI,CAAC,UAAU;AACb,eAAO,QAAQ,GAAG;AAAA,MACpB;AAGA,UAAI,iDAAgB,QAAQ;AAC1B,cAAM,eAAe,eAAe;AAAA,UAAM,CAAC,UACzC,SAAS,OAAO,SAAS,KAAK;AAAA,QAChC;AAEA,YAAI,CAAC,cAAc;AACjB,gBAAM,IAAI,uBAAuB,oBAAoB;AAAA,QACvD;AAAA,MACF;AAGA,UAAI,SAAS,aAAa,SAAS,YAAY,KAAK,IAAI,IAAI,KAAM;AAChE,cAAM,IAAI,kBAAkB,mBAAmB;AAAA,MACjD;AAGA,UAAI,OAAO;AAEX,aAAO,gBAAgB,UAAU,MAAM,QAAQ,GAAG,CAAC;AAAA,IACrD,SAAS,OAAO;AACd,YAAM,SAAS,IAAI,IAAI,IAAI,GAAG,EAAE;AAChC,YAAM,sBAAsB,GAAG,MAAM,GAAG,oBAAoB;AAE5D,UAAI,iBAAiB,mBAAmB;AACtC,eAAO,IAAI,SAAS,KAAK,UAAU,MAAM,iBAAiB,CAAC,GAAG;AAAA,UAC5D,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,oBAAoB,iBAAiB,MAAM,SAAS,yBAAyB,MAAM,OAAO,yBAAyB,mBAAmB;AAAA,YACtI,gBAAgB;AAAA,UAClB;AAAA,QACF,CAAC;AAAA,MACH,WAAW,iBAAiB,wBAAwB;AAClD,eAAO,IAAI,SAAS,KAAK,UAAU,MAAM,iBAAiB,CAAC,GAAG;AAAA,UAC5D,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,oBAAoB,iBAAiB,MAAM,SAAS,yBAAyB,MAAM,OAAO,yBAAyB,mBAAmB;AAAA,YACtI,gBAAgB;AAAA,UAClB;AAAA,QACF,CAAC;AAAA,MACH,WAAW,iBAAiB,aAAa;AACvC,eAAO,IAAI,SAAS,KAAK,UAAU,MAAM,iBAAiB,CAAC,GAAG;AAAA,UAC5D,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,gBAAgB;AAAA,UAClB;AAAA,QACF,CAAC;AAAA,MACH,OAAO;AACL,gBAAQ,MAAM,iDAAiD,KAAK;AACpE,cAAM,cAAc,IAAI,YAAY,uBAAuB;AAC3D,eAAO,IAAI,SAAS,KAAK,UAAU,YAAY,iBAAiB,CAAC,GAAG;AAAA,UAClE,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,gBAAgB;AAAA,UAClB;AAAA,QACF,CAAC;AAAA,MACH;AAAA,IACF;AAAA,EACF;AACF","sourcesContent":["import { AuthInfo } from \"@modelcontextprotocol/sdk/server/auth/types.js\";\nimport {\n  InvalidTokenError,\n  InsufficientScopeError,\n  ServerError,\n} from \"@modelcontextprotocol/sdk/server/auth/errors.js\";\nimport { withAuthContext } from \"./auth-context\";\n\ndeclare global {\n  interface Request {\n    auth?: AuthInfo;\n  }\n}\n\nexport function withMcpAuth(\n  handler: (req: Request) => Response | Promise<Response>,\n  verifyToken: (\n    req: Request,\n    bearerToken?: string\n  ) => AuthInfo | undefined | Promise<AuthInfo | undefined>,\n  {\n    required = false,\n    resourceMetadataPath = \"/.well-known/oauth-protected-resource\",\n    requiredScopes,\n  }: {\n    required?: boolean;\n    resourceMetadataPath?: string;\n    requiredScopes?: string[];\n  } = {}\n) {\n  return async (req: Request) => {\n    try {\n      const authHeader = req.headers.get(\"Authorization\");\n      const [type, token] = authHeader?.split(\" \") || [];\n\n      // Only support bearer token as per the MCP spec\n      // https://modelcontextprotocol.io/specification/2025-03-26/basic/authorization#2-6-1-token-requirements\n      const bearerToken = type?.toLowerCase() === \"bearer\" ? token : undefined;\n\n      const authInfo = await verifyToken(req, bearerToken);\n\n      if (required && !authInfo) {\n        throw new InvalidTokenError(\"No authorization provided\");\n      }\n\n      if (!authInfo) {\n        return handler(req);\n      }\n\n      // Check if token has the required scopes (if any)\n      if (requiredScopes?.length) {\n        const hasAllScopes = requiredScopes.every((scope) =>\n          authInfo.scopes.includes(scope)\n        );\n\n        if (!hasAllScopes) {\n          throw new InsufficientScopeError(\"Insufficient scope\");\n        }\n      }\n\n      // Check if the token is expired\n      if (authInfo.expiresAt && authInfo.expiresAt < Date.now() / 1000) {\n        throw new InvalidTokenError(\"Token has expired\");\n      }\n\n      // Set auth info on the request object after successful verification\n      req.auth = authInfo;\n\n      return withAuthContext(authInfo, () => handler(req));\n    } catch (error) {\n      const origin = new URL(req.url).origin;\n      const resourceMetadataUrl = `${origin}${resourceMetadataPath}`;\n\n      if (error instanceof InvalidTokenError) {\n        return new Response(JSON.stringify(error.toResponseObject()), {\n          status: 401,\n          headers: {\n            \"WWW-Authenticate\": `Bearer error=\"${error.errorCode}\", error_description=\"${error.message}\", resource_metadata=\"${resourceMetadataUrl}\"`,\n            \"Content-Type\": \"application/json\",\n          },\n        });\n      } else if (error instanceof InsufficientScopeError) {\n        return new Response(JSON.stringify(error.toResponseObject()), {\n          status: 403,\n          headers: {\n            \"WWW-Authenticate\": `Bearer error=\"${error.errorCode}\", error_description=\"${error.message}\", resource_metadata=\"${resourceMetadataUrl}\"`,\n            \"Content-Type\": \"application/json\",\n          },\n        });\n      } else if (error instanceof ServerError) {\n        return new Response(JSON.stringify(error.toResponseObject()), {\n          status: 500,\n          headers: {\n            \"Content-Type\": \"application/json\",\n          },\n        });\n      } else {\n        console.error(\"Unexpected error authenticating bearer token:\", error);\n        const serverError = new ServerError(\"Internal Server Error\");\n        return new Response(JSON.stringify(serverError.toResponseObject()), {\n          status: 500,\n          headers: {\n            \"Content-Type\": \"application/json\",\n          },\n        });\n      }\n    }\n  };\n}\n"]}